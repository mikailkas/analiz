# =============================================================================
# GELƒ∞≈ûMƒ∞≈û Fƒ∞NANSAL ANALƒ∞Z VE DEƒûERLEME Sƒ∞STEMƒ∞ (BACKTEST EKLENDƒ∞)
# Ama√ß: Hisse senedi yatƒ±rƒ±m kararlarƒ± i√ßin kapsamlƒ± analiz + ge√ßmi≈üe d√∂n√ºk test
# √ñzellikler: Finansal saƒülƒ±k, gelecek performans, deƒüerleme, hedef fiyat + backtest
# =============================================================================
# 1. KURULUM VE K√úT√úPHANELER
# =============================================================================
!pip install aiohttp nest_asyncio yfinance openpyxl pandas numpy matplotlib seaborn scikit-learn -q
import pandas as pd
import numpy as np
import asyncio
import aiohttp
import time
import logging
from datetime import datetime, timedelta
import nest_asyncio
import io
import json
from IPython.display import display, HTML, clear_output
import warnings
from pathlib import Path
import openpyxl
from openpyxl.styles import Font, PatternFill, Alignment, Border, Side, NamedStyle
from openpyxl.utils.dataframe import dataframe_to_rows
from openpyxl.formatting.rule import ColorScaleRule, DataBarRule
import yfinance as yf
import matplotlib.pyplot as plt
import seaborn as sns
from sklearn.linear_model import LinearRegression
from sklearn.preprocessing import StandardScaler
from sklearn.metrics import mean_absolute_error, mean_squared_error, r2_score
import pickle
import os
from scipy import stats
# Ayarlar
warnings.filterwarnings('ignore')
nest_asyncio.apply()
logging.basicConfig(level=logging.INFO, format='%(asctime)s - %(levelname)s - %(message)s')
logger = logging.getLogger(__name__)
# Stil ayarlarƒ±
plt.style.use('seaborn-v0_8')
sns.set_palette("husl")
print("‚úÖ Geli≈ümi≈ü Finansal Analiz Sistemi kuruldu!")
# =============================================================================
# 2. GELƒ∞≈ûMƒ∞≈û Fƒ∞NANSAL ANALƒ∞Z SINIFI (BACKTEST ƒ∞LE GENƒ∞≈ûLETƒ∞LDƒ∞)
# =============================================================================
class AdvancedFinancialAnalyzer:
    def __init__(self):
        # Finansal tablo kalemleri - geni≈ületilmi≈ü
        self.financial_items = {
            'aktif_toplam': ['Aktif Toplamƒ±', 'AKTIF TOPLAMI', 'Toplam Aktifler', 'TOPLAM VARLIKLAR'],
            'net_satis': ['Net Satƒ±≈ülar', 'NET SATI≈ûLAR', 'Satƒ±≈ü Gelirleri', 'Hasƒ±lat', 'HASILAT'],
            'satis_maliyeti': ['Satƒ±≈ülarƒ±n Maliyeti', 'SATI≈ûLARIN MALƒ∞YETƒ∞', 'Satƒ±≈ü Maliyeti'],
            'brut_kar': ['Br√ºt K√¢r', 'BR√úT KAR', 'Br√ºt Satƒ±≈ü Karƒ±', 'BR√úT SATI≈û KARI'],
            'faaliyet_giderleri': ['Faaliyet Giderleri', 'FAALƒ∞YET Gƒ∞DERLERƒ∞', 'Genel Y√∂netim Giderleri'],
            'faaliyet_kari': ['Faaliyet Karƒ±', 'FAALƒ∞YET KARI', 'Esas Faaliyet Karƒ±', 'ESAS FAALƒ∞YET KARI',
                             'FAALƒ∞YET K√ÇRI', 'ESAS FAALƒ∞YET K√ÇRI'],
            'finansman_gideri': ['Finansman Giderleri', 'Fƒ∞NANSMAN Gƒ∞DERLERƒ∞'],
            'vergi_oncesi_kar': ['Vergi √ñncesi Kar', 'VERGƒ∞ √ñNCESƒ∞ KAR', 'Vergi √ñncesi Faaliyet Karƒ±'],
            'net_kar': ['Net Kar', 'NET KAR', 'D√∂nem Karƒ±', 'D√ñNEM KARI', 'Net D√∂nem Karƒ±'],
            'ozsermaye': ['√ñzkaynaklar', '√ñZKAYNAKLAR', 'Toplam √ñzkaynaklar', 'TOPLAM √ñZKAYNAKLAR',
                          '√ñzkaynaklar Toplamƒ±', '√ñZKAYNAKLAR TOPLAMI', 'Toplam √ñzkaynak', 'TOPLAM √ñZKAYNAK',
                          'Ana Ortaklƒ±ƒüa Ait √ñzkaynaklar', 'ANA ORTAKLIƒûA Aƒ∞T √ñZKAYNAKLAR'],
            'odenmis_sermaye': ['√ñdenmi≈ü Sermaye', '√ñDENMƒ∞≈û SERMAYE', '√ñdenmi≈ü Sermaye Tutarƒ±'],
            'kisa_vadeli_yuk': ['Kƒ±sa Vadeli Y√ºk√ºml√ºl√ºkler', 'KISA VADELƒ∞ Y√úK√úML√úL√úKLER'],
            'uzun_vadeli_yuk': ['Uzun Vadeli Y√ºk√ºml√ºl√ºkler', 'UZUN VADELƒ∞ Y√úK√úML√úL√úKLER'],
            'toplam_yuk': ['Toplam Y√ºk√ºml√ºl√ºkler', 'TOPLAM Y√úK√úML√úL√úKLER', 'Y√ºk√ºml√ºl√ºkler Toplamƒ±'],
            'nakit': ['Nakit ve Nakit Benzerleri', 'NAKƒ∞T VE NAKƒ∞T BENZERLERƒ∞', 'Nakit Varlƒ±klar'],
            'stoklar': ['Stoklar', 'STOKLAR'],
            'ticari_alacaklar': ['Ticari Alacaklar', 'Tƒ∞CARƒ∞ ALACAKLAR', 'Kƒ±sa Vadeli Ticari Alacaklar'],
            'genel_yonetim_giderleri': ['Genel Y√∂netim Giderleri (-)','GENEL Y√ñNETƒ∞M Gƒ∞DERLERƒ∞'],
            'Pazarlama_Satƒ±≈ü_ve_Daƒüƒ±tƒ±m_Giderleri' :['Pazarlama, Satƒ±≈ü ve Daƒüƒ±tƒ±m Giderleri (-)','PAZARLAMA SATI≈û VE DAƒûITIM Gƒ∞DERLERƒ∞'],
            'Ara≈ütƒ±rma_ve_Geli≈ütirme_Giderleri (-)' : ['Ara≈ütƒ±rma ve Geli≈ütirme Giderleri (-)','ARA≈ûTIRMA VE GELƒ∞≈ûTƒ∞RME Gƒ∞DERLERƒ∞'],
            'Amortisman_&_ƒ∞tfa_Paylarƒ±' : [ 'Amortisman & ƒ∞tfa Paylarƒ±']
        }
        # Sekt√∂rel gruplar
        self.sektoral_groups = {
            'BANKALAR': ['AKBNK', 'GARAN', 'ISCTR', 'HALKB', 'VAKBN', 'YKBNK'],
            'HOLDƒ∞NG': ['KCHOL', 'SAHOL', 'DOHOL', 'AGHOL', 'ALARK', 'ATSYH', 'AVHOL', 'BERA', 'BLCYT', 'BRYAT', 'COSMO', 'DAGHL', 'DENGE', 'YESIL', 'ECZYT', 'ECILC', 'EUHOL', 'GLRYH', 'GLYHO', 'GSDHO', 'IEYHO', 'IHLAS', 'IHYAY', 'ISBIR', 'KERVN', 'MARKA', 'METRO', 'MMCAS', 'MZHLD', 'NTHOL', 'OSTIM', 'OYLUM', 'POLHO', 'RALYH', 'TKFEN', 'UFUK', 'VERUS', 'OTTO', 'INVEO', 'UNLU', 'HEDEF', 'INVES', 'IZINV', 'KLRHO', 'UMPAS', 'LRSHO', 'BINHO'],
            'ENERJƒ∞ √úRETƒ∞M': ['AKENR', 'GWIND', 'AKSEN', 'AKSUE', 'ALARK', 'AYEN', 'ZOREN', 'YAYLA', 'ENJSA', 'AYDEM', 'CANTE', 'NATEN', 'ODAS', 'PRKME', 'NTGAZ', 'BIOEN', 'CONSE', 'MAGEN', 'ESEN', 'PAMEL', 'BASGZ', 'MANAS', 'ARASE', 'HUNER', 'ZEDUR', 'AHGAZ', 'AKFYE', 'IZENR', 'TATEN', 'ENERY', 'CATES', 'MOGAN', 'ENTRA', 'LYDYE', 'BIGEN', 'ENDAE', 'A1YEN'],
            'TEKNOLOJƒ∞ √úR√úN Tƒ∞CARETƒ∞': ['ARENA', 'AZTEK', 'DESPC', 'DGATE', 'INDES', 'MOBTL', 'PENTA', 'TKNSA', 'INGRM'],
            'TA≈û TOPRAK': ['AFYON', 'AKCNS', 'BOBET', 'BASCM', 'BSOKE', 'BTCIM', 'CIMSA', 'CMBTN', 'CMENT', 'GOLTS', 'KONYA', 'NIBAS', 'NUHCM', 'OYAKC', 'BUCIM', 'MARBL', 'LMKDC'],
            'SPOR': ['BJKAS', 'FENER', 'GSRAY', 'TSPOR'],
            'TOPTAN PARAKENDE': ['ARENA', 'AVTUR', 'BIMAS', 'BIZIM', 'CRFSA', 'DESPC', 'DGATE', 'DOAS', 'ETILR', 'INDES', 'INTEM', 'PENTA', 'MEPET', 'MGROS', 'PSDTC', 'SANKO', 'SOKM', 'TGSAS', 'TKNSA', 'KIMMR', 'MOBTL', 'GMTAS', 'AZTEK', 'INGRM', 'EBEBK', 'DCTTR', 'LYDHO'],
            'VARLIK Y√ñNETƒ∞Mƒ∞': ['GLCVY', 'BRKVY', 'SMRVA'],
            'TURƒ∞ZM': ['GRSEL', 'AYCES', 'KSTUR', 'MAALT', 'MARTI', 'MERIT', 'METUR', 'GZNMI', 'PKENT', 'ZEDUR', 'TUREX', 'TEKTU', 'ULAS', 'MEPET'],
            'TARIM HAYVANCILIK': ['YAPRK', 'OZSUB', 'DCTTR', 'CEMZY'],
            'Sƒ∞GORTA': ['AKGRT', 'ANSGR', 'RAYSG', 'TURSG'],
            'OTOMOTƒ∞V YAN SANAYƒ∞': ['BALAT', 'BFREN', 'BRISA', 'DITAS', 'DOKTA', 'EGEEN', 'FMIZP', 'GOODY', 'JANTS', 'KATMR', 'PARSN', 'YIGIT', 'BAHKM'],
            'SAVUNMA': ['ASELS', 'OTKAR', 'PAPIL', 'SDTTR', 'ALTINY', 'ONRYT', 'KATMR', 'PATEK'],
            'MOBƒ∞LYA DEKAROSYON': ['YONGA', 'YATAS', 'ORMA', 'SUMAS', 'DGNMO', 'GENTS', 'KLSYN', 'EUREN'],
            'OTOMOTƒ∞V': ['ASUZU', 'DOAS', 'FROTO', 'KARSN', 'OTKAR', 'TMSN', 'TOASO', 'TTRAK', 'ESCAR', 'PLTUR'],
            'MENKUL KIYMET YATIRIM': ['ATLAS', 'ETYAT', 'EUKYO', 'EUYO', 'GRNYO', 'ISYAT', 'MTRYO', 'OYAYO', 'VKFYO'],
            'METAL E≈ûYA MAKƒ∞NE': ['GEREL', 'FORMT', 'KATMR', 'KLMSN', 'BMSCH', 'MAKTK', 'PRKAB', 'SAFKR', 'ULUSE', 'VESBE', 'VESTL', 'ERCB', 'IMASM', 'HKTM', 'SNICA'],
            'KIMYA PLASTƒ∞K': ['ACSEL', 'ISKPL', 'AKSA', 'ALKIM', 'KLKIM', 'AYGAZ', 'BAGFS', 'BRISA', 'DYOBY', 'EGGUB', 'EGPRO', 'EKIZ', 'EPLAS', 'GOODY', 'GUBRF', 'HEKTS', 'IZFAS', 'KORDS', 'MEGAP', 'MRSHL', 'PETKM', 'POLHO', 'SANFM', 'SASA', 'SEKUR', 'SEYKM', 'SISE', 'SODSN', 'TMPOL', 'TRCAS', 'TUPRS', 'MERCN', 'CASA', 'ISSEN', 'RNPOL', 'DNISI', 'KMPUR', 'KOPOL', 'TARKM', 'EFORC', 'BAHKM'],
            'MADENCƒ∞Lƒ∞K': ['IPEKE', 'KOZAA', 'KOZAL', 'SARKY', 'CVKMD', 'VSNMD', 'RUZYE'],
            'KAƒûIT √úR√úNLERƒ∞': ['ALKA', 'TEZOL', 'DOBUR', 'DURDO', 'VKING', 'HURGZ', 'IHGZT', 'KARTN', 'PRZMA', 'SAMAT', 'KONKA', 'MNDTR', 'LILAK'],
            'ƒ∞N≈ûAAT': ['ANELE', 'GESAN', 'BRKSN', 'CMBTN', 'YYAPI', 'YBTAS', 'ENKAI', 'IHLGM', 'BRLSM', 'ORGE', 'SANEL', 'TKFEN', 'TURGG', 'PAMEL', 'GLRMK', 'PNLSN', 'EUREN', 'AKFIS'],
            'ƒ∞LA√á': ['DEVA', 'ECILC', 'GENIL', 'TRILC', 'LKMNH', 'MPARK', 'RTALB', 'SELEC', 'SEYKM', 'EGEPO', 'ANGEN', 'MEDTR', 'ONCSM', 'TNZTP'],
            'ƒ∞MALAT': ['MRSHL', 'EMKEL', 'KARSN', 'KARTN', 'BOSSA', 'FROTO', 'KRDMA', 'TCKRC', 'KORDS', 'BRISA', 'BURCE', 'SASA', 'AKSA', 'JANTS', 'FMIZP', 'DOFER', 'ARCLK', 'BURVA', 'MEKAG', 'BRKO', 'BRMEN', 'KLMSN', 'BALAT', 'EPLAS', 'KATMR', 'AYGAZ', 'GENTS', 'BNTAS', 'BVSAN', 'GIPTA', 'GUBRF', 'KLKIM', 'KCAER', 'HATSN', 'EREGL', 'AYES', 'RNPOL', 'ALCAR', 'BRSAN', 'DMSAS', 'MAKIM', 'POLTK', 'ALVES', 'FORMT', 'ADEL', 'GEDZA', 'ALKIM', 'ASELS', 'BAYRK', 'ERBOS', 'HKTM', 'BFREN', 'DERHL', 'GEREL', 'DOGUB', 'ARZUM', 'SAFKR', 'PNLSN', 'KAPLM', 'KBORU', 'TOASO', 'DOKTA', 'HEKTS', 'SNICA', 'ORMA', 'CUSAN', 'OZATD', 'IHEVA', 'PRKAB', 'SUMAS', 'YKSLN', 'SILVR', 'ISDMR', 'IZFAS', 'IZDMC', 'TUCLK', 'CEMAS', 'ULUSE', 'CEMTS'],
            'HABERLE≈ûME': ['TCELL', 'ALCTL', 'KRONT', 'NETAS', 'TTKOM', 'IHAAS'],
            'Gƒ∞Yƒ∞M TEKSTƒ∞L': ['DAGI', 'DERIM', 'DESA', 'MAVI', 'MNDRS', 'RODRG', 'ROYAL', 'SANKO', 'SUWEN', 'VAKKO', 'KOTON', 'DERHL', 'ARSAN', 'ATEKS', 'BAYRK', 'BOSSA', 'BRKO', 'BRMEN', 'DIRIT', 'YUNSA', 'HATEK', 'KRTEK', 'LUKSK', 'RODRG', 'SKTAS', 'SNPAM', 'ENSRI', 'SUNTK', 'RUBNS', 'BLCYT', 'SONME', 'ARTMS', 'SANKO'],
            'Gƒ∞Rƒ∞≈ûƒ∞M SERMAYESƒ∞': ['GOZDE', 'HDFGS', 'HUBVC', 'ISGSY', 'VERTU', 'PRDGS', 'ICUGS', 'BULGS'],
            'GAYRƒ∞MENKUL': ['AGYO', 'AKFGY', 'AKMGY', 'AKSGY', 'ALGYO', 'ATAGY', 'AVGYO', 'DGGYO', 'DZGYO', 'YGYO', 'YGGYO', 'EKGYO', 'HLGYO', 'IDGYO', 'IHLGM', 'ISGYO', 'KLGYO', 'KRGYO', 'KUYAS', 'MRGYO', 'MSGYO', 'NUGYO', 'OZGYO', 'OZKY', 'PAGYO', 'PEKGY', 'RYGYO', 'SNGYO', 'SRVGY', 'TDGYO', 'TRGYO', 'ZRGYO', 'TSGYO', 'VKGYO', 'KZBGY', 'PSGYO', 'KGYO', 'DAPGM', 'SEGYO', 'ADESE', 'EYGYO', 'FZLGY', 'ASGYO', 'KZGYO', 'ADGYO', 'MHRGY', 'VRGYO', 'BEGYO', 'SURGY', 'AVPGY', 'RGYAS', 'PEHOL', 'LYDHO', 'AHSGY', 'EDIP', 'EGEGY'],
            'Fƒ∞N. Kƒ∞RALAMA': ['ISFIN', 'QNBFL', 'SEKFK', 'VAKFN', 'QNBFK'],
            'FAKTORƒ∞NG': ['CRDFA', 'GARFA', 'LIDFA', 'ULUFA', 'DSTFK'],
            'ENERJƒ∞ TEKNOLOJƒ∞': ['SMRTG', 'ALFAS', 'ASTOR', 'EUPWR', 'CWENE', 'GESAN', 'YEOTK', 'KONTR', 'BRLSM', 'ORGE', 'SAYAS', 'EKOS', 'ONRYT', 'KLYPV'],
            'EMEKLƒ∞Lƒ∞K': ['ANHYT', 'AGESA'],
            'DESTEK VE Hƒ∞ZMET': ['BEYAZ', 'CEOEM', 'AKYHO', 'FLAP', 'SNKRN', 'MACKO', 'HRKET', 'PCILT', 'DOCO'],
            'DAYANIKLI T√úKETƒ∞M MALLARI': ['ALCAR', 'ARCLK', 'SILVR', 'VESBE', 'VESTL', 'ARZUM', 'IHEVA', 'KLMSN'],
            'CAM SERAMƒ∞K': ['QUAGR', 'EGSER', 'KUTPO', 'SISE', 'USAK', 'BIENY', 'KLSER', 'CGCAM', 'SERNT'],
            'Bƒ∞Lƒ∞≈ûƒ∞M VE YAZILIM': ['ARDYZ', 'ARENA', 'ATATP', 'VBTYZ', 'DESPC', 'DGATE', 'ESCOM', 'FONET', 'KONTR', 'MTRKS', 'INDES', 'PENTA', 'KAREL', 'KFEIN', 'KRONT', 'LINK', 'LOGO', 'NETAS', 'PAPIL', 'PKART', 'SMART', 'EDATA', 'MIATK', 'MOBTL', 'YEOTK', 'HTTBT', 'OBASE', 'AZTEK', 'INGRM', 'FORTE', 'REEDR', 'PATEK', 'ODINE', 'SKYLP', 'ONRYT', 'INTEK'],
            'ARACI KURUM': ['OYYAT', 'GEDIK', 'GLBMD', 'INFO', 'ISMEN', 'OSMEN', 'TERA', 'A1CAP', 'SKYMD'],
            'ANA METAL': ['BRSAN', 'BURCE', 'BURVA', 'CELHA', 'CEMAS', 'CEMTS', 'CUSAN', 'DMSAS', 'DOKTA', 'YKSLN', 'ERBOS', 'EREGL', 'ISDMR', 'IZMDC', 'KRDMA', 'KRDMB', 'KRDMD', 'BMSCH', 'POLTK', 'SARKY', 'TUCLK', 'ERCB', 'BMSTL', 'KCAER', 'KBORU', 'MEGMT', 'KOCMT', 'OZYSR'],
            'AMBALAJ': ['BNTAS', 'BAKAB', 'DURDO', 'EMNIS', 'GEDZA', 'KAPLM', 'SEKUR', 'KRPLS', 'BARMA', 'MNDTR', 'OZRDN'],
            'GIDA PERAKENDE': ['MGROS', 'VESTL', 'BIMAS', 'BIZIM', 'CRFSA', 'GMTAS', 'SOKM', 'KIMMR', 'MOPAS'],
            'GIDA VE ƒ∞√áECEK': ['AEFES', 'AVOD', 'BANVT', 'ORCAY', 'CCOLA', 'DARDL', 'ARMGD', 'ERSU', 'FADE', 'FRIGO', 'KENT', 'KNFRT', 'KRSTL', 'MERKO', 'PENGD', 'PETUN', 'PINSU', 'SELGD', 'TATGD', 'TBORG', 'TUKAS', 'ULKER', 'ULUUN', 'VANGD', 'KRVGD', 'SELVA', 'ELITE', 'YYLGD', 'KUVVA', 'SOKE', 'GOKNR', 'EKSUN', 'BIGCH', 'KAYSE', 'ATAKP', 'OFSYM', 'BYDNR', 'OYLUM', 'DMRGD', 'TABGD', 'AGROT', 'BORSK', 'OBAMS', 'ALKLC', 'SEGMN', 'EFORC', 'GUNDG', 'CEMZY', 'DURKN', 'GRTHO', 'BALSU', 'BESLR'],
            'ULA≈ûTIRMA': ['THYAO', 'TAVHL', 'CLEBI', 'GSDDE', 'LIDER', 'PGSUS', 'RYSAS', 'TLMAN', 'PLTUR', 'PASEU', 'HOROZ', 'HRKET', 'BINBN']
        }
        # Hesaplama form√ºlleri - geni≈ületilmi≈ü
        self.ratios = {
            'roe': lambda data: self.safe_divide(data.get('net_kar', 0), data.get('ozsermaye', 0)) * 100,
            'roa': lambda data: self.safe_divide(data.get('net_kar', 0), data.get('aktif_toplam', 0)) * 100,
            'ROIC': lambda d: self.safe_divide(d.get('faaliyet_kari', 0),d.get('aktif_toplam', 0) - d.get('kisa_vadeli_yuk', 0)) * 100,
            'EBITDA_MARJI': lambda d: self.safe_divide(
                d.get('faaliyet_kari', 0) + d.get('Amortisman_&_ƒ∞tfa_Paylarƒ±', 0),
                d.get('net_satis', 0)
            ) * 100,
            'net_kar_marji': lambda data: self.safe_divide(data.get('net_kar', 0), data.get('net_satis', 0)) * 100,
            'brut_kar_marji': lambda data: self.safe_divide(data.get('brut_kar', 0), data.get('net_satis', 0)) * 100,
            'faaliyet_kar_marji': lambda data: self.safe_divide(data.get('faaliyet_kari', 0), data.get('net_satis', 0)) * 100,
            'aktif_devir_hizi': lambda data: self.safe_divide(data.get('net_satis', 0), data.get('aktif_toplam', 0)),
            'ozsermaye_carpani': lambda data: self.safe_divide(data.get('aktif_toplam', 0), data.get('ozsermaye', 0)),
            'borc_orani': lambda data: self.safe_divide((data.get('kisa_vadeli_yuk', 0) + data.get('uzun_vadeli_yuk', 0)), data.get('aktif_toplam', 0)) * 100,
            'likidite_orani': lambda data: self.safe_divide(
                data.get('nakit', 0) + data.get('ticari_alacaklar', 0) + data.get('stoklar', 0),
                data.get('kisa_vadeli_yuk', 0)
            ),
            'giderler': lambda data: data.get('genel_yonetim_giderleri', 0) +
                                    data.get('Pazarlama_Satƒ±≈ü_ve_Daƒüƒ±tƒ±m_Giderleri', 0) +
                                    data.get('Ara≈ütƒ±rma_ve_Geli≈ütirme_Giderleri (-)', 0),
            'nakit_orani': lambda data: self.safe_divide(data.get('nakit', 0), data.get('kisa_vadeli_yuk', 0)),
            'asit_test': lambda data: self.safe_divide(
                data.get('nakit', 0) + data.get('ticari_alacaklar', 0),
                data.get('kisa_vadeli_yuk', 0)
            ),
            'pd_dd': lambda data: self.safe_divide(data.get('market_cap', 0), data.get('ozsermaye', 0)),
            'fk': lambda data: self.safe_divide(data.get('current_price', 0), data.get('eps', 0)),
            'ev_ebitda': lambda data: self.safe_divide(data.get('market_cap', 0), data.get('faaliyet_kari', 0) + data.get('Amortisman_&_ƒ∞tfa_Paylarƒ±', 0)),
            'sermaye_karliligi': lambda data: self.safe_divide(data.get('net_kar', 0), data.get('odenmis_sermaye', 0)) * 100,
            'faaliyet_kari_marji': lambda data: self.safe_divide(data.get('faaliyet_kari', 0), data.get('net_satis', 0)) * 100,
        }
        # √ñnbellek ve rate limiting i√ßin deƒüi≈ükenler
        self.cache = {}
        self.cache_file = "financial_cache.pkl"
        self.last_call_time = {}
        self.rate_limit_delay = 0.5  # 500ms between API calls
        self.results = []

        # √ñnbelleƒüi y√ºkle
        self.load_cache()

    def load_cache(self):
        """√ñnbelleƒüi dosyadan y√ºkle"""
        try:
            if os.path.exists(self.cache_file):
                with open(self.cache_file, 'rb') as f:
                    self.cache = pickle.load(f)
                logger.info(f"√ñnbellek y√ºklendi: {len(self.cache)} kayƒ±t")
        except Exception as e:
            logger.error(f"√ñnbellek y√ºklenemedi: {str(e)}")
            self.cache = {}
    def save_cache(self):
        """√ñnbelleƒüi dosyaya kaydet"""
        try:
            with open(self.cache_file, 'wb') as f:
                pickle.dump(self.cache, f)
        except Exception as e:
            logger.error(f"√ñnbellek kaydedilemedi: {str(e)}")

    def safe_divide(self, numerator, denominator):
        """G√ºvenli b√∂lme i≈ülemi"""
        if denominator == 0 or pd.isna(denominator) or pd.isna(numerator):
            return 0
        try:
            return float(numerator) / float(denominator)
        except:
            return 0
    def validate_financial_data(self, data):
        """Finansal verilerin tutarlƒ±lƒ±ƒüƒ±nƒ± kontrol et"""
        warnings = []
        # Muhasebe dengesi kontrol√º
        if data.get('aktif_toplam', 0) < (data.get('ozsermaye', 0) + data.get('toplam_yuk', 0)):
            warnings.append("‚ö†Ô∏è Muhasebe dengesi uyu≈ümuyor: Aktif ‚â† √ñzkaynak + Y√ºk√ºml√ºl√ºkler")
        # Sƒ±fƒ±r satƒ±≈üla kar kontrol√º
        if data.get('net_satis', 0) == 0 and data.get('net_kar', 0) > 0:
            warnings.append("‚ö†Ô∏è Sƒ±fƒ±r satƒ±≈üla kar elde edilmi≈ü")
        # Negatif √∂zkaynak kontrol√º
        if data.get('ozsermaye', 0) < 0:
            warnings.append("‚ö†Ô∏è Negatif √∂zkaynak tespit edildi")
        # Y√ºksek bor√ß oranƒ± kontrol√º
        borc_orani = self.safe_divide(
            data.get('kisa_vadeli_yuk', 0) + data.get('uzun_vadeli_yuk', 0),
            data.get('aktif_toplam', 0)
        ) * 100
        if borc_orani > 80:
            warnings.append(f"‚ö†Ô∏è √áok y√ºksek bor√ß oranƒ±: %{borc_orani:.1f}")
        return warnings
    async def get_financial_data_api(self, session, ticker, period_config):
        """API'den finansal veri √ßeker - rate limiting ile"""
        # Rate limiting kontrol√º
        now = time.time()
        if ticker in self.last_call_time and (now - self.last_call_time[ticker]) < self.rate_limit_delay:
            await asyncio.sleep(self.rate_limit_delay - (now - self.last_call_time[ticker]))
        # √ñnbellek kontrol√º
        cache_key = f"{ticker}_{period_config['year1']}_{period_config['period1']}"
        if cache_key in self.cache:
            logger.debug(f"{ticker} i√ßin √∂nbellekten veri alƒ±ndƒ±")
            return self.cache[cache_key]
        url = (f"https://www.isyatirim.com.tr/_layouts/15/IsYatirim.Website/Common/Data.aspx/MaliTablo"
               f"?companyCode={ticker}&exchange=TRY&financialGroup=XI_29"
               f"&year1={period_config['year1']}&period1={period_config['period1']}"
               f"&year2={period_config['year2']}&period2={period_config['period2']}"
               f"&year3={period_config['year3']}&period3={period_config['period3']}"
               f"&year4={period_config['year4']}&period4={period_config['period4']}"
               f"&_={int(time.time() * 1000)}")
        try:
            async with session.get(url, timeout=30) as response:
                self.last_call_time[ticker] = time.time()
                if response.status == 200:
                    json_data = await response.json()
                    # √ñnbelleƒüe kaydet
                    self.cache[cache_key] = json_data
                    return json_data
                else:
                    logger.error(f"{ticker} i√ßin API hatasƒ±: {response.status}")
                    return None
        except aiohttp.ClientError as e:
            logger.error(f"{ticker} API baƒülantƒ± hatasƒ±: {str(e)}")
            return self.get_cached_data(ticker, period_config)
        except Exception as e:
            logger.error(f"{ticker} API hatasƒ±: {str(e)}")
            return None
    def get_cached_data(self, ticker, period_config):
        """√ñnbellekten veri d√∂nd√ºr"""
        cache_key = f"{ticker}_{period_config['year1']}_{period_config['period1']}"
        return self.cache.get(cache_key, None)
    async def get_market_data(self, ticker, historical_date=None):
        """Yahoo Finance √ºzerinden piyasa deƒüeri ve EPS verilerini √ßeker"""
        try:
            stock = yf.Ticker(f"{ticker}.IS")
            if historical_date:
                # Tarih aralƒ±ƒüƒ±nƒ± belirle
                end_date = datetime.strptime(historical_date, '%Y-%m-%d')
                start_date = end_date - timedelta(days=365)
                # Ge√ßmi≈ü verileri al
                hist = stock.history(start=start_date.strftime('%Y-%m-%d'), end=end_date.strftime('%Y-%m-%d'))
                if hist.empty:
                    logger.warning(f"{ticker} i√ßin {historical_date} tarihinde veri bulunamadƒ±")
                    return {
                        'market_cap': 0,
                        'eps': 0,
                        'current_price': 0,
                        'book_value_per_share': 0,
                        'price_trend': 0
                    }
                # En son tarihteki verileri al
                last_row = hist.iloc[-1]
                current_price = last_row['Close']
                # Piyasa deƒüeri tahmini (o d√∂nemdeki hisse sayƒ±sƒ± * fiyat)
                # Not: Bu bir tahmindir, kesin bilgi i√ßin daha detaylƒ± veri gerekir
                shares_outstanding = stock.info.get('sharesOutstanding', 0)
                if shares_outstanding == 0:
                    # Alternatif y√∂ntem: mevcut piyasa deƒüeri ve mevcut fiyatƒ± kullan
                    current_market_cap = stock.info.get('marketCap', 0)
                    current_price_now = stock.info.get('currentPrice', 0)
                    if current_price_now > 0:
                        shares_outstanding = current_market_cap / current_price_now
                market_cap = shares_outstanding * current_price / 1000000  # Milyon TL'ye √ßevir
                # EPS ve defter deƒüeri i√ßin mevcut verileri kullan (ge√ßmi≈ü veriler sƒ±nƒ±rlƒ±)
                eps = stock.info.get('trailingEps', 0)
                book_value_per_share = stock.info.get('bookValue', 0)
                # Fiyat trendini hesapla
                price_trend = self.calculate_price_trend(hist)
                return {
                    'market_cap': market_cap,
                    'eps': eps,
                    'current_price': current_price,
                    'book_value_per_share': book_value_per_share,
                    'price_trend': price_trend
                }
            else:
                # Mevcut verileri al
                info = stock.info
                market_cap = info.get('marketCap', 0) / 1000000  # Milyon TL'ye √ßevir
                eps = info.get('trailingEps', 0)
                current_price = info.get('currentPrice', 0)
                book_value_per_share = info.get('bookValue', 0)
                # Ge√ßmi≈ü fiyat verileri (trend analizi i√ßin)
                hist = stock.history(period="1y")
                price_trend = self.calculate_price_trend(hist)
                return {
                    'market_cap': market_cap,
                    'eps': eps,
                    'current_price': current_price,
                    'book_value_per_share': book_value_per_share,
                    'price_trend': price_trend
                }
        except Exception as e:
            logger.error(f"{ticker} i√ßin piyasa verisi alƒ±namadƒ±: {str(e)}")
            return {
                'market_cap': 0,
                'eps': 0,
                'current_price': 0,
                'book_value_per_share': 0,
                'price_trend': 0
            }
    def calculate_price_trend(self, hist_data):
        """Fiyat trendini hesapla (yƒ±llƒ±k deƒüi≈üim %)"""
        if len(hist_data) < 2:
            return 0
        try:
            first_price = hist_data['Close'].iloc[0]
            last_price = hist_data['Close'].iloc[-1]
            return ((last_price - first_price) / first_price) * 100
        except:
            return 0
    def extract_financial_values(self, df, period_col):
        """DataFrame'den finansal deƒüerleri √ßƒ±karƒ±r"""
        values = {}
        found_items = []
        for key, possible_names in self.financial_items.items():
            value = 0
            found = False
            for name in possible_names:
                matching_rows = df[df['Kalem'].str.contains(name, case=False, na=False, regex=False)]
                if not matching_rows.empty:
                    val = matching_rows.iloc[0][period_col]
                    if pd.notna(val) and val != 0:
                        value = float(val)
                        found = True
                        found_items.append(f"{key}: {name} = {value}")
                        break
            if not found and key == 'faaliyet_kari':
                logger.warning(f"Faaliyet k√¢rƒ± bulunamadƒ±. Kalemler: {df['Kalem'].tolist()}")
            values[key] = value
        logger.debug(f"Bulunan finansal kalemler: {found_items}")
        return values
    def calculate_ratios(self, financial_data):
        """Finansal oranlarƒ± hesaplar"""
        ratios = {}
        for ratio_name, formula in self.ratios.items():
            try:
                ratios[ratio_name] = formula(financial_data)
            except Exception as e:
                ratios[ratio_name] = 0
                logger.error(f"{ratio_name} oranƒ± hesaplanamadƒ±: {str(e)}")
        return ratios
    def calculate_financial_health_score(self, data):
        """Finansal saƒülƒ±k skorunu hesapla (0-100)"""
        score = 0
        details = {}
        # ROE Skoru (0-25)
        roe = data.get('roe', 0)
        if roe > 20:
            score += 25
            details['ROE'] = f"25/25 (√áok iyi: %{roe:.1f})"
        elif roe > 15:
            score += 20
            details['ROE'] = f"20/25 (ƒ∞yi: %{roe:.1f})"
        elif roe > 10:
            score += 15
            details['ROE'] = f"15/25 (Orta: %{roe:.1f})"
        elif roe > 5:
            score += 10
            details['ROE'] = f"10/25 (Zayƒ±f: %{roe:.1f})"
        else:
            details['ROE'] = f"0/25 (√áok zayƒ±f: %{roe:.1f})"
        # Bor√ß Oranƒ± Skoru (0-20)
        borc_orani = data.get('borc_orani', 100)
        if borc_orani < 30:
            score += 20
            details['Bor√ß'] = f"20/20 (√áok d√º≈ü√ºk: %{borc_orani:.1f})"
        elif borc_orani < 50:
            score += 15
            details['Bor√ß'] = f"15/20 (D√º≈ü√ºk: %{borc_orani:.1f})"
        elif borc_orani < 70:
            score += 10
            details['Bor√ß'] = f"10/20 (Orta: %{borc_orani:.1f})"
        else:
            details['Bor√ß'] = f"0/20 (Y√ºksek: %{borc_orani:.1f})"
        # Likidite Skoru (0-20)
        likidite = data.get('likidite_orani', 0)
        if likidite > 2:
            score += 20
            details['Likidite'] = f"20/20 (√áok iyi: {likidite:.1f})"
        elif likidite > 1.5:
            score += 15
            details['Likidite'] = f"15/20 (ƒ∞yi: {likidite:.1f})"
        elif likidite > 1:
            score += 10
            details['Likidite'] = f"10/20 (Orta: {likidite:.1f})"
        else:
            details['Likidite'] = f"0/20 (D√º≈ü√ºk: {likidite:.1f})"
        # Kar Marjƒ± Skoru (0-20)
        kar_marji = data.get('net_kar_marji', 0)
        if kar_marji > 15:
            score += 20
            details['Kar Marjƒ±'] = f"20/20 (√áok iyi: %{kar_marji:.1f})"
        elif kar_marji > 10:
            score += 15
            details['Kar Marjƒ±'] = f"15/20 (ƒ∞yi: %{kar_marji:.1f})"
        elif kar_marji > 5:
            score += 10
            details['Kar Marjƒ±'] = f"10/20 (Orta: %{kar_marji:.1f})"
        else:
            details['Kar Marjƒ±'] = f"0/20 (D√º≈ü√ºk: %{kar_marji:.1f})"
        # B√ºy√ºme Skoru (0-15)
        price_trend = data.get('price_trend', 0)
        if price_trend > 50:
            score += 15
            details['B√ºy√ºme'] = f"15/15 (√áok hƒ±zlƒ±: %{price_trend:.1f})"
        elif price_trend > 20:
            score += 12
            details['B√ºy√ºme'] = f"12/15 (Hƒ±zlƒ±: %{price_trend:.1f})"
        elif price_trend > 0:
            score += 8
            details['B√ºy√ºme'] = f"8/15 (Pozitif: %{price_trend:.1f})"
        else:
            details['B√ºy√ºme'] = f"0/15 (Negatif: %{price_trend:.1f})"
        return {
            'score': min(score, 100),
            'details': details,
            'category': self.get_score_category(score)
        }
    def get_score_category(self, score):
        """Skora g√∂re kategori belirle"""
        if score >= 80:
            return "√áOK ƒ∞Yƒ∞"
        elif score >= 60:
            return "ƒ∞Yƒ∞"
        elif score >= 40:
            return "ORTA"
        elif score >= 20:
            return "ZAYIF"
        else:
            return "√áOK ZAYIF"
    def calculate_valuation_score(self, data):
        """Deƒüerleme skorunu hesapla (0-100) - Ne kadar ucuz? - D√úZELTƒ∞LMƒ∞≈û VERSƒ∞YON"""
        score = 100  # Ba≈ülangƒ±√ßta tam puan, indirimler uygulanacak
        details = {}

        # F/K Oranƒ± ƒ∞ndirimi - D√úZELTƒ∞LDƒ∞: D√º≈ü√ºk F/K = Ucuz = Pozitif
        fk = data.get('fk', 0)
        if fk <= 0:  # Negatif veya sƒ±fƒ±r F/K
            score -= 50
            details['F/K'] = f"-50 (Ge√ßersiz F/K: {fk:.1f})"
        elif fk < 5:  # √áok ucuz
            score += 15
            details['F/K'] = f"+15 (√áok ucuz: {fk:.1f})"
            score = min(score, 100)
        elif fk < 10:  # Ucuz
            score += 5
            details['F/K'] = f"+5 (Ucuz: {fk:.1f})"
            score = min(score, 100)
        elif fk < 15:  # Hafif pahalƒ±
            score -= 5
            details['F/K'] = f"-5 (Hafif pahalƒ±: {fk:.1f})"
        elif fk < 20:  # Pahalƒ±
            score -= 15
            details['F/K'] = f"-15 (Pahalƒ±: {fk:.1f})"
        elif fk < 30:  # √áok pahalƒ±
            score -= 25
            details['F/K'] = f"-25 (√áok pahalƒ±: {fk:.1f})"
        else:  # A≈üƒ±rƒ± pahalƒ±
            score -= 40
            details['F/K'] = f"-40 (A≈üƒ±rƒ± pahalƒ±: {fk:.1f})"

        # PD/DD ƒ∞ndirimi - D√úZELTƒ∞LDƒ∞: D√º≈ü√ºk PD/DD = Ucuz = Pozitif
        pd_dd = data.get('pd_dd', 0)
        if pd_dd <= 0:  # Negatif veya sƒ±fƒ±r PD/DD
            score -= 40
            details['PD/DD'] = f"-40 (Ge√ßersiz PD/DD: {pd_dd:.1f})"
        elif pd_dd < 2:  # √áok ucuz
            score += 25
            details['PD/DD'] = f"+25 (√áok ucuz: {pd_dd:.1f})"
            score = min(score, 100)
        elif pd_dd < 3:  # Ucuz
            score += 10
            details['PD/DD'] = f"+10 (Ucuz: {pd_dd:.1f})"
            score = min(score, 100)
        elif pd_dd < 4:  # Hafif pahalƒ±
            score += 5
            details['PD/DD'] = f"+5 (Hafif pahalƒ±: {pd_dd:.1f})"
        elif pd_dd < 7:  # Orta pahalƒ±
            score -= 5
            details['PD/DD'] = f"-5 (Orta pahalƒ±: {pd_dd:.1f})"
        elif pd_dd < 10:  # Pahalƒ±
            score -= 10
            details['PD/DD'] = f"-10 (Pahalƒ±: {pd_dd:.1f})"
        else:  # √áok pahalƒ±
            score -= 25
            details['PD/DD'] = f"-30 (√áok pahalƒ±: {pd_dd:.1f})"

        # EV/EBITDA ƒ∞ndirimi - D√úZELTƒ∞LDƒ∞: D√º≈ü√ºk EV/EBITDA = Ucuz = Pozitif
        ev_ebitda = data.get('ev_ebitda', 0)
        if ev_ebitda <= 0:  # Negatif veya sƒ±fƒ±r EV/EBITDA
            score -= 30
            details['EV/EBITDA'] = f"-30 (Ge√ßersiz EV/EBITDA: {ev_ebitda:.1f})"
        elif ev_ebitda < 3:  # √áok ucuz
            score += 25
            details['EV/EBITDA'] = f"+10 (√áok ucuz: {ev_ebitda:.1f})"
            score = min(score, 100)
        elif ev_ebitda < 6:  # Ucuz
            score += 15
            details['EV/EBITDA'] = f"+5 (Ucuz: {ev_ebitda:.1f})"
            score = min(score, 100)
        elif ev_ebitda < 10:  # Hafif pahalƒ±
            score += 10
            details['EV/EBITDA'] = f"+10 (Hafif pahalƒ±: {ev_ebitda:.1f})"
        elif ev_ebitda < 15:  # Pahalƒ±
            score -= 10
            details['EV/EBITDA'] = f"-8 (Pahalƒ±: {ev_ebitda:.1f})"
        elif ev_ebitda < 20:  # √áok pahalƒ±
            score -= 15
            details['EV/EBITDA'] = f"-15 (√áok pahalƒ±: {ev_ebitda:.1f})"
        else:  # A≈üƒ±rƒ± pahalƒ±
            score -= 25
            details['EV/EBITDA'] = f"-25 (A≈üƒ±rƒ± pahalƒ±: {ev_ebitda:.1f})"

        return {
            'score': max(score, 0),
            'details': details,
            'category': self.get_score_category(score)
        }
    def calculate_future_performance_score(self, data):
        """Gelecek performans skorunu hesapla (0-100)"""
        score = 0
        details = {}
        # ROE Trendi
        roe = data.get('roe', 0)
        if roe > 50:
            score += 30
            details['ROE'] = f"30/30 (S√ºrd√ºr√ºlebilir y√ºksek k√¢rlƒ±lƒ±k: %{roe:.1f})"
        elif roe > 25:
            score += 20
            details['ROE'] = f"25/30 (ƒ∞yi k√¢rlƒ±lƒ±k: %{roe:.1f})"
        elif roe > 15:
            score += 10
            details['ROE'] = f"15/30 (Orta k√¢rlƒ±lƒ±k: %{roe:.1f})"
        elif roe > 5:
            score += 5
            details['ROE'] = f"5/30 (Orta k√¢rlƒ±lƒ±k: %{roe:.1f})"
        else:
            details['ROE'] = f"0/30 (D√º≈ü√ºk k√¢rlƒ±lƒ±k: %{roe:.1f})"
        # Yatƒ±rƒ±m Oranƒ±
        yatirim_orani = self.safe_divide(
            data.get('ozsermaye', 0) - data.get('odenmis_sermaye', 0),
            data.get('ozsermaye', 0)
        ) * 100
        if yatirim_orani > 50:
            score += 25
            details['Yatƒ±rƒ±m'] = f"25/25 (Y√ºksek sermaye birikimi: %{yatirim_orani:.1f})"
        elif yatirim_orani > 30:
            score += 20
            details['Yatƒ±rƒ±m'] = f"20/25 (Orta sermaye birikimi: %{yatirim_orani:.1f})"
        elif yatirim_orani > 10:
            score += 10
            details['Yatƒ±rƒ±m'] = f"10/25 (D√º≈ü√ºk sermaye birikimi: %{yatirim_orani:.1f})"
        else:
            details['Yatƒ±rƒ±m'] = f"0/25 (Sƒ±nƒ±rlƒ± sermaye birikimi: %{yatirim_orani:.1f})"
        # Faaliyet K√¢rƒ± Trendi
        faaliyet_kari = data.get('faaliyet_kari', 0)
        if faaliyet_kari > 0:
            score += 20
            details['Faaliyet K√¢rƒ±'] = f"20/20 (Pozitif faaliyet k√¢rƒ±: {faaliyet_kari:.1f}M TL)"
        else:
            details['Faaliyet K√¢rƒ±'] = f"0/20 (Negatif faaliyet k√¢rƒ±: {faaliyet_kari:.1f}M TL)"
        # Sekt√∂r B√ºy√ºme Potansiyeli (basit bir yakla≈üƒ±m)
        sektor = data.get('sektor', 'BILINMIYOR')
        yuksek_potansiyel_sektorler = ['TEKNOLOJƒ∞', 'ENERJƒ∞', 'SAVUNMA', 'Bƒ∞Lƒ∞≈ûƒ∞M', 'ƒ∞LA√á']
        orta_potansiyel_sektorler = ['HOLDƒ∞NG', 'OTOMOTƒ∞V', 'GIDA', 'PERAKENDE']
        if any(sektor.startswith(s) for s in yuksek_potansiyel_sektorler):
            score += 25
            details['Sekt√∂r'] = f"25/25 (Y√ºksek b√ºy√ºme potansiyeli: {sektor})"
        elif any(sektor.startswith(s) for s in orta_potansiyel_sektorler):
            score += 15
            details['Sekt√∂r'] = f"15/25 (Orta b√ºy√ºme potansiyeli: {sektor})"
        else:
            score += 5
            details['Sekt√∂r'] = f"5/25 (D√º≈ü√ºk b√ºy√ºme potansiyeli: {sektor})"
        return {
            'score': min(score, 100),
            'details': details,
            'category': self.get_score_category(score)
        }
    def calculate_sector_averages(self, results):
        """Sekt√∂r ortalamalarƒ±nƒ± hesapla"""
        sector_pe = {}
        sector_pb = {}
        for sector in set(r['SEKT√ñR'] for r in results):
            pe_values = []
            pb_values = []
            for r in results:
                if r['SEKT√ñR'] == sector:
                    if r['F/K'] > 0:
                        pe_values.append(r['F/K'])
                    if r['PD/DD'] > 0:
                        pb_values.append(r['PD/DD'])
            sector_pe[sector] = np.mean(pe_values) if pe_values else 15.0
            sector_pb[sector] = np.mean(pb_values) if pb_values else 1.5
        return sector_pe, sector_pb
    def calculate_target_price(self, result, sector_pe_avg, sector_pb_avg):
        """Hedef fiyat hesapla - SEKT√ñR ORTALAMALARI KULLANILMADAN"""
        # Gerekli verileri al
        eps = result.get('EPS', 0)
        book_value = result.get('DEFTER DEƒûERƒ∞', 0)
        current_price = result.get('Fƒ∞YAT', 0)
        future_score = result.get('GELECEK SKORU', 0)

        # Ge√ßersiz veri kontrol√º
        if eps <= 0 or book_value <= 0 or current_price <= 0:
            return {
                'HEDEF Fƒ∞YAT': 0,
                'Y√úKSELƒ∞≈û POTANSƒ∞YELƒ∞ (%)': 0,
                'HEDEF Fƒ∞YAT A√áIKLAMA': 'Yetersiz veri'
            }

        # B√ºy√ºme √ßarpanƒ±
        if future_score >= 80:
            growth_multiplier = 1.2
        elif future_score >= 60:
            growth_multiplier = 1.1
        elif future_score < 40:
            growth_multiplier = 0.9
        else:
            growth_multiplier = 1.0

        # Standart √ßarpanlar (sekt√∂r ortalamalarƒ± yerine)
        standard_pe = 12.0  # Standart F/K √ßarpanƒ±
        standard_pb = 1.8   # Standart PD/DD √ßarpanƒ±

        # Hedef fiyat hesaplamalarƒ±
        target_pe = eps * standard_pe * growth_multiplier
        target_pb = book_value * standard_pb * growth_multiplier

        # Aƒüƒ±rlƒ±klƒ± ortalama (60% PE, 40% PB)
        target_price = (target_pe * 0.6 + target_pb * 0.4)

        # Y√ºkseli≈ü potansiyeli
        upside_potential = ((target_price - current_price) / current_price) * 100

        return {
            'HEDEF Fƒ∞YAT': round(target_price, 2),
            'Y√úKSELƒ∞≈û POTANSƒ∞YELƒ∞ (%)': round(upside_potential, 1),
            'HEDEF Fƒ∞YAT A√áIKLAMA': f"Standart F/K: {standard_pe:.1f}, Standart PD/DD: {standard_pb:.1f}, B√ºy√ºme √áarpanƒ±: {growth_multiplier:.1f}x"
        }
    async def analyze_ticker(self, session, ticker, semaphore, historical_date=None):
        """Tek bir hisse i√ßin kapsamlƒ± analiz yapar"""
        async with semaphore:
            try:
                # G√ºncel ve ge√ßmi≈ü d√∂nem verileri
                if historical_date:
                    # Tarih bilgilerini ayarla
                    hist_date = datetime.strptime(historical_date, '%Y-%m-%d')
                    year1 = hist_date.year
                    month1 = hist_date.month
                    # D√∂nem belirleme (3 aylƒ±k periyotlar)
                    if month1 <= 3:
                        period1 = 3
                    elif month1 <= 6:
                        period1 = 6
                    elif month1 <= 9:
                        period1 = 9
                    else:
                        period1 = 12
                    # √ñnceki d√∂nemler
                    year2 = year1
                    period2 = period1 - 3 if period1 > 3 else 12
                    if period2 == 12:
                        year2 = year1 - 1
                    year3 = year1 - 1
                    period3 = 12
                    year4 = year1 - 1
                    period4 = 9
                    period_config = {
                        "year1": year1, "period1": period1,
                        "year2": year2, "period2": period2,
                        "year3": year3, "period3": period3,
                        "year4": year4, "period4": period4,
                    }
                else:
                    period_config = {
                        "year1": 2025, "period1": 6,
                        "year2": 2025, "period2": 3,
                        "year3": 2024, "period3": 12,
                        "year4": 2024, "period4": 9,
                    }
                print(f"üîÑ {ticker} analiz ediliyor...")
                # Veri √ßekme
                api_data = await self.get_financial_data_api(session, ticker, period_config)
                market_data = await self.get_market_data(ticker, historical_date)
                # Sekt√∂r bilgisini belirle
                sector = "BILINMIYOR"
                for sec, stocks in self.sektoral_groups.items():
                    if ticker in stocks:
                        sector = sec
                        break
                if api_data and "value" in api_data and len(api_data["value"]) > 0:
                    # Veri i≈üleme
                    df_data = []
                    for item in api_data["value"]:
                        row = {
                            "Kalem": item.get("itemDescTr", ""),
                            f"{period_config['year1']}-{period_config['period1']}": item.get("value1"),
                            f"{period_config['year2']}-{period_config['period2']}": item.get("value2"),
                            f"{period_config['year3']}-{period_config['period3']}": item.get("value3"),
                            f"{period_config['year4']}-{period_config['period4']}": item.get("value4")
                        }
                        df_data.append(row)
                    df = pd.DataFrame(df_data)
                    numeric_cols = [
                        f"{period_config['year1']}-{period_config['period1']}",
                        f"{period_config['year2']}-{period_config['period2']}",
                        f"{period_config['year3']}-{period_config['period3']}",
                        f"{period_config['year4']}-{period_config['period4']}"
                    ]
                    for col in numeric_cols:
                        df[col] = pd.to_numeric(df[col], errors='coerce') / 1000000
                    periods = numeric_cols
                    financial_data = {}
                    latest_period = None
                    for period in periods:
                        financial_data = self.extract_financial_values(df, period)
                        if financial_data.get('faaliyet_kari', 0) != 0:
                            latest_period = period
                            break
                    if not latest_period:
                        latest_period = periods[0]
                        logger.warning(f"{ticker} i√ßin faaliyet k√¢rƒ± t√ºm d√∂nemlerde 0. Varsayƒ±lan d√∂nem: {latest_period}")
                    # Verileri birle≈ütir
                    financial_data.update(market_data)
                    financial_data['sektor'] = sector
                    # Veri doƒürulama
                    warnings = self.validate_financial_data(financial_data)
                    # Oranlarƒ± hesapla
                    ratios = self.calculate_ratios(financial_data)
                    financial_data.update(ratios)
                    # Skorlarƒ± hesapla
                    health_score = self.calculate_financial_health_score(financial_data)
                    valuation_score = self.calculate_valuation_score(financial_data)
                    future_score = self.calculate_future_performance_score(financial_data)
                    # Genel yatƒ±rƒ±m skoru (aƒüƒ±rlƒ±klƒ± ortalama)
                    investment_score = (
                        health_score['score'] * 0.4 +
                        valuation_score['score'] * 0.35 +
                        future_score['score'] * 0.25
                    )
                    # Sonu√ßlarƒ± olu≈ütur
                    result = {
                        'Hƒ∞SSE KODU': ticker,
                        'SEKT√ñR': sector,
                        'D√ñNEM': latest_period,
                        'Fƒ∞YAT': round(market_data.get('current_price', 0), 2),
                        'EPS': round(market_data.get('eps', 0), 2),
                        'DEFTER DEƒûERƒ∞': round(market_data.get('book_value_per_share', 0), 2),
                        'NET SATI≈û(M)': round(financial_data.get('net_satis', 0), 1),
                        'NET KAR(M)': round(financial_data.get('net_kar', 0), 1),
                        'TOPLAM VARLIK(M)': round(financial_data.get('aktif_toplam', 0), 1),
                        '√ñZKAYNAK(M)': round(financial_data.get('ozsermaye', 0), 1),
                        '√ñDENMƒ∞≈û SERMAYE(M)':round(financial_data.get('odenmis_sermaye',0),1),
                        'FAALƒ∞YET KARI(M)': round(financial_data.get('faaliyet_kari', 0), 1),
                        'ROE (%)': round(ratios.get('roe', 0), 2),
                        'ROA (%)': round(ratios.get('roa', 0), 2),
                        'ROIC (%)': round(ratios.get('ROIC', 0), 2),
                        'NET.K.MARJ(%)': round(ratios.get('net_kar_marji', 0), 2),
                        'BR√úT.K.MARJ(%)': round(ratios.get('brut_kar_marji', 0), 2),
                        'FAAL.K.MARJ(%)': round(ratios.get('faaliyet_kar_marji', 0), 2),
                        'EBITDA_MARJI': round(ratios.get('EBITDA_MARJI', 0), 2),
                        'BOR√á ORAN(%)': round(ratios.get('borc_orani', 0), 2),
                        'Lƒ∞Kƒ∞T ORAN': round(ratios.get('likidite_orani', 0), 2),
                        'NAKƒ∞T ORAN': round(ratios.get('nakit_orani', 0), 2),
                        'ASƒ∞T.T.ORAN': round(ratios.get('asit_test', 0), 2),
                        'PD/DD': round(ratios.get('pd_dd', 0), 2),
                        'F/K': round(ratios.get('fk', 0), 2),
                        'EV/EBITDA': round(ratios.get('ev_ebitda', 0), 2),
                        'Fƒ∞YAT TRENDƒ∞ (%)': round(market_data.get('price_trend', 0), 2),
                        'SAƒûLIK SKORU': health_score['score'],
                        'SAƒûLIK KATEGORƒ∞': health_score['category'],
                        'DEƒûERLEME SKORU': valuation_score['score'],
                        'DEƒûERLEME KATEGORƒ∞': valuation_score['category'],
                        'GELECEK SKORU': future_score['score'],
                        'GELECEK KATEGORƒ∞': future_score['category'],
                        'YATIRIM SKORU': round(investment_score, 1),
                        'YATIRIM KATEGORƒ∞': self.get_score_category(investment_score),
                        'UYARILAR': "; ".join(warnings) if warnings else "Yok"
                    }

                    print(f"‚úÖ {ticker} tamamlandƒ± - Yatƒ±rƒ±m Skoru: {result['YATIRIM SKORU']}/100")
                    return result
                else:
                    logger.error(f"{ticker} i√ßin veri bulunamadƒ±")
                    return None
            except Exception as e:
                logger.error(f"{ticker} analiz hatasƒ±: {str(e)}")
                return None
    async def batch_analyze(self, tickers, batch_size=10, max_concurrent=3, historical_date=None):
        """Batch processing ile b√ºy√ºk veri setlerini analiz et"""
        all_results = []
        for i in range(0, len(tickers), batch_size):
            batch = tickers[i:i+batch_size]
            print(f"üîÑ Batch {i//batch_size + 1}/{(len(tickers)-1)//batch_size + 1} i≈üleniyor...")
            connector = aiohttp.TCPConnector(limit=20, limit_per_host=max_concurrent)
            timeout = aiohttp.ClientTimeout(total=60)
            async with aiohttp.ClientSession(connector=connector, timeout=timeout) as session:
                semaphore = asyncio.Semaphore(max_concurrent)
                tasks = [self.analyze_ticker(session, ticker, semaphore, historical_date) for ticker in batch]
                batch_results = await asyncio.gather(*tasks, return_exceptions=True)
                valid_results = [r for r in batch_results if r is not None and not isinstance(r, Exception)]
                all_results.extend(valid_results)
                # Ara sonu√ßlarƒ± kaydet
                self.save_intermediate_results(all_results)
                # √ñnbelleƒüi kaydet
                self.save_cache()
                print(f"‚úÖ Batch tamamlandƒ±: {len(valid_results)}/{len(batch)} hisse analiz edildi")

        # Sekt√∂r ortalamalarƒ±nƒ± hesaplama kƒ±smƒ±nƒ± kaldƒ±rdƒ±k
        # Her hisse i√ßin hedef fiyat hesapla (artƒ±k sekt√∂r ortalamalarƒ±nƒ± kullanmadan)
        for result in all_results:
            # Sekt√∂r ortalamalarƒ± yerine None deƒüerleri g√∂nderiyoruz, fonksiyon i√ßinde kullanƒ±lmayacak
            target_data = self.calculate_target_price(result, None, None)
            result.update(target_data)

        return all_results
    def save_intermediate_results(self, results):
        """Ara sonu√ßlarƒ± kaydet"""
        try:
            timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
            filename = f"intermediate_results_{timestamp}.pkl"
            with open(filename, 'wb') as f:
                pickle.dump(results, f)
            logger.info(f"Ara sonu√ßlar kaydedildi: {filename}")
        except Exception as e:
            logger.error(f"Ara sonu√ßlar kaydedilemedi: {str(e)}")
    def display_results(self, results, top_n=20):
        """Sonu√ßlarƒ± Colab'da g√ºzel formatta g√∂sterir"""
        if not results:
            print("‚ùå G√∂sterilecek sonu√ß yok!")
            return
        df = pd.DataFrame(results)
        df = df.sort_values('YATIRIM SKORU', ascending=False).head(top_n)
        print("üìä YATIRIM ANALƒ∞Z SONU√áLARI")
        print("=" * 80)
        print(f"üìà En Y√ºksek Yatƒ±rƒ±m Skoru: {df['YATIRIM SKORU'].max():.1f}/100 ({df.loc[df['YATIRIM SKORU'].idxmax(), 'Hƒ∞SSE KODU']})")
        print(f"üìâ En D√º≈ü√ºk Yatƒ±rƒ±m Skoru: {df['YATIRIM SKORU'].min():.1f}/100 ({df.loc[df['YATIRIM SKORU'].idxmin(), 'Hƒ∞SSE KODU']})")
        print(f"üìä Ortalama Yatƒ±rƒ±m Skoru: {df['YATIRIM SKORU'].mean():.1f}/100")
        print("\n")
        # HTML tablo olu≈ütur
        html_table = df.to_html(classes='table table-striped', table_id='analysis_table', escape=False)
        # CSS stilleri
        css = """
        <style>
            #analysis_table {
                font-size: 12px;
                width: 100%;
                border-collapse: collapse;
            }
            #analysis_table th {
                background-color: #366092;
                color: white;
                padding: 8px;
                text-align: center;
            }
            #analysis_table td {
                padding: 6px;
                text-align: right;
            }
            #analysis_table tr:nth-child(even) {
                background-color: #f2f2f2;
            }
            .positive { color: green; font-weight: bold; }
            .negative { color: red; font-weight: bold; }
            .score-very-good { background-color: #d4edda; }
            .score-good { background-color: #d1ecf1; }
            .score-medium { background-color: #fff3cd; }
            .score-weak { background-color: #f8d7da; }
            .score-very-weak { background-color: #f5c6cb; }
        </style>
        """
        display(HTML(css + html_table))
        return df
    def plot_analysis(self, results):
        """Analiz sonu√ßlarƒ±nƒ± g√∂rselle≈ütir"""
        if not results:
            print("‚ùå G√∂rselle≈ütirilecek veri yok!")
            return
        df = pd.DataFrame(results)
        # 1. Yatƒ±rƒ±m Skoru Daƒüƒ±lƒ±mƒ±
        plt.figure(figsize=(12, 8))
        plt.subplot(2, 2, 1)
        sns.histplot(df['YATIRIM SKORU'], bins=20, kde=True, color='skyblue')
        plt.title('Yatƒ±rƒ±m Skoru Daƒüƒ±lƒ±mƒ±')
        plt.xlabel('Yatƒ±rƒ±m Skoru')
        # 2. Sekt√∂rel Kar≈üƒ±la≈ütƒ±rma
        plt.subplot(2, 2, 2)
        sector_avg = df.groupby('SEKT√ñR')['YATIRIM SKORU'].mean().sort_values(ascending=False).head(10)
        sns.barplot(x=sector_avg.values, y=sector_avg.index, palette='viridis')
        plt.title('Sekt√∂rel Yatƒ±rƒ±m Skorlarƒ± (ƒ∞lk 10)')
        plt.xlabel('Ortalama Yatƒ±rƒ±m Skoru')
        # 3. F/K vs ROE
        plt.subplot(2, 2, 3)
        scatter = plt.scatter(
            x=df['F/K'],
            y=df['ROE (%)'],
            s=df['YATIRIM SKORU']*2,
            c=df['YATIRIM SKORU'],
            cmap='RdYlGn',
            alpha=0.7
        )
        plt.xlabel('F/K Oranƒ±')
        plt.ylabel('ROE (%)')
        plt.title('F/K vs ROE (Boyut = Yatƒ±rƒ±m Skoru)')
        plt.colorbar(scatter, label='Yatƒ±rƒ±m Skoru')
        # 4. Hedef Fiyat vs Mevcut Fiyat
        plt.subplot(2, 2, 4)
        plt.scatter(
            x=df['Fƒ∞YAT'],
            y=df['HEDEF Fƒ∞YAT'],
            c=df['Y√úKSELƒ∞≈û POTANSƒ∞YELƒ∞ (%)'],
            cmap='RdYlGn',
            s=100,
            alpha=0.7
        )
        plt.plot([df['Fƒ∞YAT'].min(), df['Fƒ∞YAT'].max()],
                [df['Fƒ∞YAT'].min(), df['Fƒ∞YAT'].max()],
                'r--', alpha=0.5)
        plt.xlabel('Mevcut Fiyat')
        plt.ylabel('Hedef Fiyat')
        plt.title('Hedef Fiyat vs Mevcut Fiyat')
        plt.colorbar(label='Y√ºkseli≈ü Potansiyeli (%)')
        plt.tight_layout()
        plt.show()
        # En iyi 10 hisse i√ßin detaylƒ± grafik
        top_10 = df.nlargest(10, 'YATIRIM SKORU')
        plt.figure(figsize=(14, 8))
        metrics = ['SAƒûLIK SKORU', 'DEƒûERLEME SKORU', 'GELECEK SKORU']
        x = np.arange(len(top_10))
        width = 0.25
        for i, metric in enumerate(metrics):
            plt.bar(x + i*width, top_10[metric], width, label=metric)
        plt.xlabel('Hisse Senetleri')
        plt.ylabel('Skor')
        plt.title('En ƒ∞yi 10 Hisse i√ßin Detaylƒ± Skorlar')
        plt.xticks(x + width, top_10['Hƒ∞SSE KODU'], rotation=45)
        plt.legend()
        plt.grid(axis='y', linestyle='--', alpha=0.7)
        plt.tight_layout()
        plt.show()
    def export_to_excel(self, results, filename="yatirim_analizi.xlsx", backtest_results=None):
        """Sonu√ßlarƒ± Excel'e aktar"""
        if not results:
            print("‚ùå Excel'e aktarƒ±lacak sonu√ß yok!")
            return
        df = pd.DataFrame(results)
        df = df.sort_values('YATIRIM SKORU', ascending=False)
        # S√ºtun sƒ±rasƒ±nƒ± d√ºzenle
        columns = [
            'Hƒ∞SSE KODU', 'SEKT√ñR', 'Fƒ∞YAT', 'HEDEF Fƒ∞YAT', 'Y√úKSELƒ∞≈û POTANSƒ∞YELƒ∞ (%)', 'D√ñNEM',
            'YATIRIM SKORU', 'YATIRIM KATEGORƒ∞', 'SAƒûLIK SKORU', 'SAƒûLIK KATEGORƒ∞',
            'DEƒûERLEME SKORU', 'DEƒûERLEME KATEGORƒ∞', 'GELECEK SKORU', 'GELECEK KATEGORƒ∞',
            'EPS', 'DEFTER DEƒûERƒ∞', 'NET SATI≈û(M)', 'NET KAR(M)', 'TOPLAM VARLIK(M)',
            '√ñZKAYNAK(M)','√ñDENMƒ∞≈û SERMAYE(M)','FAALƒ∞YET KARI(M)', 'ROE (%)', 'ROA (%)', 'ROIC (%)',
            'NET.K.MARJ(%)', 'BR√úT.K.MARJ(%)', 'FAAL.K.MARJ(%)', 'EBITDA_MARJI',
            'BOR√á ORAN(%)', 'Lƒ∞Kƒ∞T ORAN', 'NAKƒ∞T ORAN', 'ASƒ∞T.T.ORAN', 'PD/DD', 'F/K',
            'EV/EBITDA', 'Fƒ∞YAT TRENDƒ∞ (%)', 'HEDEF Fƒ∞YAT A√áIKLAMA', 'UYARILAR'
        ]
        df = df[columns]
        # Excel'e yaz
        with pd.ExcelWriter(filename, engine='openpyxl') as writer:
            # Ana analiz sayfasƒ±
            df.to_excel(writer, sheet_name='YATIRIM ANALƒ∞Zƒ∞', index=False)
            # Sekt√∂rel analiz
            sector_analysis = []
            for sector in df['SEKT√ñR'].unique():
                sector_data = df[df['SEKT√ñR'] == sector]
                if not sector_data.empty:
                    sector_summary = {
                        'SEKT√ñR': sector,
                        'Hƒ∞SSE SAYISI': len(sector_data),
                        'ORT. YATIRIM SKORU': sector_data['YATIRIM SKORU'].mean(),
                        'ORT. SAƒûLIK SKORU': sector_data['SAƒûLIK SKORU'].mean(),
                        'ORT. DEƒûERLEME SKORU': sector_data['DEƒûERLEME SKORU'].mean(),
                        'ORT. GELECEK SKORU': sector_data['GELECEK SKORU'].mean(),
                        'ORT. Y√úKSELƒ∞≈û POTANSƒ∞YELƒ∞': sector_data['Y√úKSELƒ∞≈û POTANSƒ∞YELƒ∞ (%)'].mean(),
                        'ORT. ROE': sector_data['ROE (%)'].mean(),
                        'ORT. F/K': sector_data['F/K'].mean(),
                        'ORT. PD/DD': sector_data['PD/DD'].mean()
                    }
                    sector_analysis.append(sector_summary)
            pd.DataFrame(sector_analysis).to_excel(writer, sheet_name='SEKT√ñREL ANALƒ∞Z', index=False)
            # En iyi hisseler
            top_investment = df.nlargest(20, 'YATIRIM SKORU')[
                ['Hƒ∞SSE KODU', 'SEKT√ñR', 'YATIRIM SKORU', 'Fƒ∞YAT', 'HEDEF Fƒ∞YAT', 'Y√úKSELƒ∞≈û POTANSƒ∞YELƒ∞ (%)', 'F/K', 'PD/DD', 'ROE (%)']
            ]
            top_investment.to_excel(writer, sheet_name='EN ƒ∞Yƒ∞ 20 YATIRIM', index=False)
            # Ucuz hisseler
            cheap_stocks = df[df['DEƒûERLEME SKORU'] >= 70].nlargest(20, 'YATIRIM SKORU')[
                ['Hƒ∞SSE KODU', 'SEKT√ñR','√ñDENMƒ∞≈û SERMAYE(M)', 'DEƒûERLEME SKORU', 'Fƒ∞YAT', 'HEDEF Fƒ∞YAT', 'Y√úKSELƒ∞≈û POTANSƒ∞YELƒ∞ (%)', 'F/K', 'PD/DD', 'ROE (%)']
            ]
            cheap_stocks.to_excel(writer, sheet_name='EN UCUZ 20 Hƒ∞SSE', index=False)
            # Saƒülƒ±klƒ± hisseler
            healthy_stocks = df[df['SAƒûLIK SKORU'] >= 70].nlargest(20, 'YATIRIM SKORU')[
                ['Hƒ∞SSE KODU', 'SEKT√ñR', 'SAƒûLIK SKORU', 'Fƒ∞YAT', 'HEDEF Fƒ∞YAT', 'Y√úKSELƒ∞≈û POTANSƒ∞YELƒ∞ (%)', 'ROE (%)', 'BOR√á ORAN(%)', 'Lƒ∞Kƒ∞T ORAN']
            ]
            healthy_stocks.to_excel(writer, sheet_name='EN SAƒûLIKLI 20 Hƒ∞SSE', index=False)
            # Y√ºksek potansiyelli hisseler
            high_potential = df[df['Y√úKSELƒ∞≈û POTANSƒ∞YELƒ∞ (%)'] > 20].nlargest(20, 'YATIRIM SKORU')[
                ['Hƒ∞SSE KODU', 'SEKT√ñR', 'Y√úKSELƒ∞≈û POTANSƒ∞YELƒ∞ (%)', 'Fƒ∞YAT', 'HEDEF Fƒ∞YAT', 'YATIRIM SKORU', 'F/K', 'PD/DD', 'ROE (%)']
            ]
            high_potential.to_excel(writer, sheet_name='Y√úKSEK POTANSƒ∞YELLƒ∞ 20', index=False)




        # Formatlama
        self.format_excel_advanced(filename)
        print(f"‚úÖ Excel dosyasƒ± olu≈üturuldu: {filename}")
        # Colab i√ßin indirme
        try:
            from google.colab import files
            files.download(filename)
        except:
            print("‚ö†Ô∏è Dosya otomatik olarak indirilemedi. L√ºtfen manuel olarak indirin.")
    def format_excel_advanced(self, filename):
        """Excel dosyasƒ±nƒ± profesyonel formatta d√ºzenler"""
        try:
            wb = openpyxl.load_workbook(filename)
            # T√ºm sayfalar i√ßin formatlama
            for sheet_name in wb.sheetnames:
                ws = wb[sheet_name]
                # Ba≈ülƒ±k formatƒ±
                header_font = Font(name='Arial', size=10, bold=True, color="FFFFFF")
                header_fill = PatternFill(start_color="2F5597", end_color="2F5597", fill_type="solid")
                header_alignment = Alignment(horizontal="center", vertical="center")
                # Veri formatƒ±
                data_font = Font(name='Arial', size=9)
                data_alignment = Alignment(horizontal="right", vertical="center")
                # Ba≈ülƒ±klarƒ± formatla
                for cell in ws[1]:
                    cell.font = header_font
                    cell.fill = header_fill
                    cell.alignment = header_alignment
                # Verileri formatla
                for row in ws.iter_rows(min_row=2):
                    for i, cell in enumerate(row):
                        cell.font = data_font
                        # Sayƒ±sal s√ºtunlarƒ± formatla
                        if isinstance(cell.value, (int, float)):
                            if 'SKORU' in str(ws.cell(row=1, column=i+1).value):
                                cell.number_format = '#,##0'
                            elif '%' in str(ws.cell(row=1, column=i+1).value):
                                cell.number_format = '#,##0.00'
                            elif i >= 15:  # Finansal veriler
                                cell.number_format = '#,##0.0'
                            else:
                                cell.number_format = '#,##0.00'
                            cell.alignment = data_alignment
                        else:
                            cell.alignment = Alignment(horizontal="center", vertical="center")
                # S√ºtun geni≈ülikleri
                if sheet_name == 'YATIRIM ANALƒ∞Zƒ∞':
                    column_widths = {
                        'A': 12,  # Hƒ∞SSE KODU
                        'B': 25,  # SEKT√ñR
                        'C': 15,  # ANALƒ∞Z TARƒ∞Hƒ∞ (varsa)
                        'D': 10,  # Fƒ∞YAT
                        'E': 12,  # HEDEF Fƒ∞YAT
                        'F': 18,  # Y√úKSELƒ∞≈û POTANSƒ∞YELƒ∞
                        'G': 10,  # D√ñNEM
                        'H': 15,  # YATIRIM SKORU
                        'I': 18,  # YATIRIM KATEGORƒ∞
                        'J': 15,  # SAƒûLIK SKORU
                        'K': 18,  # SAƒûLIK KATEGORƒ∞
                        'L': 18,  # DEƒûERLEME SKORU
                        'M': 20,  # DEƒûERLEME KATEGORƒ∞
                        'N': 18,  # GELECEK SKORU
                        'O': 20,  # GELECEK KATEGORƒ∞
                        'P': 12,  # EPS
                        'Q': 15,  # DEFTER DEƒûERƒ∞
                        'R': 20,  # NET SATI≈û
                        'S': 15,  # NET KAR
                        'T': 20,  # TOPLAM VARLIK
                        'U': 15,  # √ñZKAYNAK
                        'V': 20,  # FAALƒ∞YET KARI
                        'W': 10,  # ROE
                        'X': 10,  # ROA
                        'Y': 12,  # ROIC
                        'Z': 15,  # NET KAR MARJI
                        'AA': 15, # BR√úT KAR MARJI
                        'AB': 15, # FAALƒ∞YET KAR MARJI
                        'AC': 15, # EBITDA MARJI
                        'AD': 15, # BOR√á ORANI
                        'AE': 15, # Lƒ∞Kƒ∞T ORAN
                        'AF': 15, # NAKƒ∞T ORAN
                        'AG': 15, # ASƒ∞T TEST
                        'AH': 12, # PD/DD
                        'AI': 10, # F/K
                        'AJ': 12, # EV/EBITDA
                        'AK': 15, # Fƒ∞YAT TRENDƒ∞
                        'AL': 50, # HEDEF Fƒ∞YAT A√áIKLAMA
                        'AM': 50  # UYARILAR
                    }
                    # Eƒüer ANALƒ∞Z TARƒ∞Hƒ∞ s√ºtunu varsa diƒüer s√ºtunlarƒ± kaydƒ±r
                    if 'ANALƒ∞Z TARƒ∞Hƒ∞' in [cell.value for cell in ws[1]]:
                        for col in list(column_widths.keys())[3:]:
                            column_widths[col] = column_widths[chr(ord(col)-1)]
                    for col, width in column_widths.items():
                        if col in ws.column_dimensions:
                            ws.column_dimensions[col].width = width
                # Ko≈üullu formatlama - Yatƒ±rƒ±m Skoru
                if sheet_name == 'YATIRIM ANALƒ∞Zƒ∞':
                    investment_col = None
                    for i, cell in enumerate(ws[1], 1):
                        if cell.value == 'YATIRIM SKORU':
                            investment_col = openpyxl.utils.get_column_letter(i)
                            break
                    if investment_col:
                        # Renk skalasƒ±
                        color_scale = ColorScaleRule(
                            start_type='min', start_color='FF0000',
                            mid_type='percentile', mid_value=50, mid_color='FFFF00',
                            end_type='max', end_color='00FF00'
                        )
                        ws.conditional_formatting.add(f'{investment_col}2:{investment_col}{ws.max_row}', color_scale)
            wb.save(filename)
            print("‚úÖ Excel formatlarƒ± uygulandƒ±")
        except Exception as e:
            print(f"‚ö†Ô∏è Excel formatlama hatasƒ±: {str(e)}")
# Analyzer ve BackTest instance'larƒ± olu≈ütur
analyzer = AdvancedFinancialAnalyzer()
print("‚úÖ Geli≈ümi≈ü Finansal Analiz hazƒ±r!")

# =============================================================================
# 3. Hƒ∞SSE Lƒ∞STESƒ∞ TANIMALAMA
# =============================================================================
bist500_tickers = ["A1CAP","A1YEN","ACSEL","ADEL","ADESE","ADGYO‚Äã","AEFES‚Äã","AFYON‚Äã","AGESA","AGHOL","AGROT","AGYO","AHGAZ","AKBNK","AKCNS","AKENR","AKFGY","AKFIS","AKFYE",
"AKGRT","AKMGY","AKSA","AKSEN","AKSGY","AKSUE","AKYHO","ALARK","ALBRK","ALCAR","ALCTL","ALFAS","ALGYO","ALKA","ALKIM","ALKLC","ALMAD","ALTINY","ALVES","ANELE","ANGEN","ANHYT",
"ANSGR","ARASE","ARCLK","ARDYZ","ARENA","ARMGD","ARSAN","ARTMS","ARZUM","ASELS","ASGYO","ASTOR","ASUZU","ATAGY","ATAKP","ATATP","ATEKS","ATLAS","ATSYH","AVGYO","AVHOL","AVOD",
"AVPGY","AVTUR","AYCES","AYDEM","AYEN","AYES","AYGAZ","AZTEK","BAGFS","BAHKM","BAKAB","BALAT","BALSU","BANVT","BARMA","BASCM‚Äã","BASGZ","BAYRK","BEGYO","BERA","BEYAZ","BFREN",
"BIENY","BIGCH","BIMAS","BINBN","BINHO","BIOEN","BIZIM","BJKAS","BLCYT","BMSCH","BMSTL","BNTAS","BOBET","BORLS","BORSK","BOSSA","BRISA","BRKO","BRKSN","BRKVY","BRLSM",
"BRMEN","BRSAN","BRYAT","BSOKE","BTCIM","BUCIM","BURCE","BURVA","BVSAN","BYDNR","CANTE","CASA","CATES","CCOLA","CELHA","CEMAS","CEMTS","CEOEM","CEMZY","CGCAM",
"CIMSA‚Äã","CLEBI","CMBTN","CMENT","CONSE","COSMO","CRDFA","CRFSA","CUSAN","CVKMD","CWENE","DAGHL","DAGI","DAPGM","DARDL","DENGE","DERHL","DERIM","DESA","DCTTR","DSTFK",
"DESPC","DEVA","DGATE","DGGYO","DGNMO","DIRIT","DITAS","DMRGD","DMSAS","DNISI","DOAS","DOBUR","DOCO","DOFER","DOGUB","DOHOL","DOKTA","DURDO","DYOBY","DURKN",
"DZGYO","EBEBK","ECILC","ECZYT","EDATA","EDIP","EFORC","EGEGY","EGEEN","EGEPO","EGGUB","EGPRO","EGSER","EKGYO","EKIZ","EKOS","EKSUN","ELITE","EMKEL","EMNIS","ENERY","ENDEA",
"ENJSA","ENKAI","ENSRI","ENTRA","EPLAS","ERBOS","ERCB","EREGL","ERSU","ESCAR","ESCOM","ESEN","ETILR","ETYAT","EUHOL","EUKYO","EUPWR","EUREN","EUYO","EYGYO",
"FADE","FENER","FLAP","FMIZP","FONET","FORMT","FORTE","FRIGO","FROTO","FZLGY","GARAN","GARFA","GEDIK","GEDZA","GENIL","GENTS","GEREL","GESAN","GIPTA",
"GLBMD","GLCVY","GLRMK","GLRYH","GLYHO","GMTAS","GOKNR","GOLTS","GOODY","GOZDE","GRNYO","GRSEL","GRTHO","GRTRK","GSDDE","GSDHO‚Äã","GSRAY","GUBRF","GUNDG","GWIND","GZNMI","HALKB",
"HATEK","HATSN","HDFGS","HEDEF","HEKTS","HKTM","HLGYO","HOROZ","HRKET","HTTBT","HUBVC","HUNER","HURGZ","ICBCT‚Äã","ICUGS","ICUGS","IDGYO","IEYHO","IHAAS","IHEVA‚Äã",
"IHGZT","IHLAS","IHLGM","IHYAY","IMASM","INDES","INFO","INGRM","INTEM‚Äã","INVEO","INVES","IPEKE","ISATR","ISBIR","‚ÄãISCTR","ISDMR","ISFIN","ISGSY","ISGYO",
"ISKPL","ISKUR","ISMEN","ISSEN","ISYAT","IZENR","IZFAS","IZINV","IZMDC","JANTS","KAPLM","KAREL","KARSN","KARTN","KARYE","KATMR","KAYSE","KBORU","KCAER",
"KCHOL","KENT","KERVN","KERVT‚Äã","KFEIN","KGYO","KIMMR","KLGYO","KLKIM","KLMSN","KLNMA","KLRHO","KLSER","KLSYN","KLYPV","KMPUR","KNFRT","KOCMT","KONKA","KONTR","KONYA",
"KOPOL","KORDS","KOTON","KOZAA","KOZAL","KRDMA","KRDMB","KRDMD","KRGYO","KRONT","KRPLS","KRSTL","KRTEK","KRVGD","KSTUR","KTLEV","KTSKR","KUTPO","KUVVA","KUYAS",
"KZBGY","KZGYO","LIDER","LIDFA","LILAK","LINK","LKMNH","LOGO","LRSHO","LUKSK","LYDHO","LYDYE","MAALT","MACKO","MAGEN","MAKIM","MAKTK","MANAS","MARBL","MARKA","MARTI","MAVI",
"MEDTR","MEGAP","MEGMT","MEKAG","MEPET","MERCN","MERIT","MERKO‚Äã","METRO","METUR","MGROS","MHRGY","MIATK","MIPAZ","MMCAS","MNDRS","MNDTR","MOBTL","MPARK","MOBTL","MOGAN","MOPAS",
"MRGYO","MRSHL","MSGYO","MTRKS","MTRYO","MZHLD","NATEN","NETAS","NIBAS","NTGAZ","NTHOL","NUGYO","NUHCM","OBAMS","OBASE","ODAS","ODINE","OFSYM","ONCSM","ONRYT", "ORCAY","ORGE",
"ORMA","OSMEN","OSTIM","OTKAR","OTTO‚Äã","OYAKC","OYAYO","OYLUM","OYYAT","OZATD","OZGYO","OZKGY","OZRDN","OZSUB","OZYSR","PAGYO","PAMEL","PAPIL","PARSN","PASEU","PCILT","PATEK","PEHOL",
"PEKGY","PENGD","PENTA","PETKM","PETUN","PGSUS","PINSU","PKART","PKENT","PLTUR","PNLSN","PNSUT‚Äã","POLHO","POLTK","PRDGS","PRKAB","PRKME","PRZMA",
"PSDTC","PSGYO","QNBFB","QNBFL","QUAGR","RALYH","RAYSG","REEDR","RGYAS","RNPOL","RODRG","ROYAL","RTALB","RUBNS","RUZYE","RYGYO","RYSAS","SAFKR","SAHOL","SAMAT","SANEL",
"SANFM","SANKO","SARKY","SASA","SAYAS","SDTTR","SEGMN","SEGYO‚Äã","SEKFK","SEKUR","SELEC","SELGD","SELVA","SERNT","SEYKM‚Äã","SILVR","SISE","SKBNK","SKTAS","SKYLP","SKYMD",
"SMART‚Äã","SMRTG","SNGYO","SNICA","SNKRN","SNPAM","SODSN","SOKE","SOKM","SONME","SRVGY","SUMAS","SUNTK","SURGY","SUWEN","TABGD","TARKM","TATEN","TATGD",
"TAVHL","TBORG","TCELL","TCKRC","TDGYO","TEKTU","TERA","TETMT","TEZOL","TGSAS","THYAO","TKFEN","TKNSA","TLMAN","TMPOL","TMSN","TNZTP‚Äã","TOASO","TRCAS","TRGYO",
"TRILC","TSGYO","TSKB","TSPOR","TTKOM","TTRAK","TUCLK","TUKAS","TUPRS","TUREX","TURGG","TURSG","UFUK","ULAS","ULKER","ULUFA","ULUSE","ULUUN","UMPAS",
"UNLU‚Äã","USAK","UZERB","VAKBN","VAKFN","VAKKO","VANGD‚Äã","VBTYZ","VERTU","VERUS","VESBE","VESTL","VKFYO","VKGYO","VKING","VSNMD","YAPRK","YATAS","YAYLA","YBTAS",
"YEOTK","YESIL","YGGYO","YGYO‚Äã","YIGIT","YKBNK","YKSLN","YONGA","YUNSA","YYAPI","YYLGD","ZEDUR","ZOREN","ZRGYO"
]
bist30_tickers = [
    "THYAO", "AKBNK", "GARAN", "ISCTR", "KCHOL", "TUPRS", "ARCLK", "BIMAS",
    "SAHOL", "KOZAL", "SISE", "TAVHL", "TCELL", "TKFEN", "TOASO", "TRKCM",
    "VESTL", "YKBNK", "PGSUS", "DOHOL", "EKGYO", "ENKAI", "FROTO", "HALKB",
    "KONTR", "KRDMD", "MGROS", "PETKM", "VAKBN", "AEFES"
]
print("üìã Hisse listeleri hazƒ±r!")
print(f"üî¨ BIST30 listesi: {len(bist30_tickers)} hisse")
print(f"üî¨ BIST500 listesi: {len(bist500_tickers)} hisse")
# =============================================================================
# 4. HIZLI TEST B√ñL√úM√ú
# =============================================================================
print("\nüöÄ HIZLI TEST BA≈ûLIYOR...")
print("=" * 50)
quick_test = ["THYAO", "MACKO", "SASA"]
async def quick_analysis():
    results = await analyzer.batch_analyze(bist500_tickers, batch_size=3, max_concurrent=3)
    return results
test_results = await quick_analysis()
if test_results:
    print("\n‚úÖ HIZLI TEST BA≈ûARILI!")
    analyzer.display_results(test_results)
    analyzer.plot_analysis(test_results)
    analyzer.export_to_excel(test_results, "hisse_analizi.xlsx")
else:
    print("‚ùå Test ba≈üarƒ±sƒ±z - API baƒülantƒ±sƒ±nƒ± kontrol edin")

# =============================================================================
# 6. KULLANIM TALƒ∞MATLARI
# =============================================================================
print("""
üéØ KULLANIM TALƒ∞MATLARI:
========================
1Ô∏è‚É£ K√ú√á√úK TEST ƒ∞√áƒ∞N:
   results = await analyzer.batch_analyze(bist30_tickers[:10], batch_size=5, max_concurrent=2)
   analyzer.display_results(results)
   analyzer.plot_analysis(results)
   analyzer.export_to_excel(results, "kucuk_test.xlsx")
2Ô∏è‚É£ B√úY√úK ANALƒ∞Z ƒ∞√áƒ∞N:
   results = await analyzer.batch_analyze(bist30_tickers, batch_size=10, max_concurrent=3)
   analyzer.display_results(results, top_n=30)
   analyzer.plot_analysis(results)
   analyzer.export_to_excel(results, "buyuk_analiz.xlsx")
3Ô∏è‚É£ Bƒ∞ST500 TAM ANALƒ∞Z ƒ∞√áƒ∞N:
   results = await analyzer.batch_analyze(bist500_tickers, batch_size=20, max_concurrent=5)
   analyzer.display_results(results, top_n=50)
   analyzer.plot_analysis(results)
   analyzer.export_to_excel(results, "bist500_tam_analiz.xlsx")
4Ô∏è‚É£ √ñZEL Hƒ∞SSE Lƒ∞STESƒ∞ ƒ∞√áƒ∞N:
   my_stocks = ["THYAO", "SASA", "KCHOL", "TUPRS", "ARCLK"]
   results = await analyzer.batch_analyze(my_stocks, batch_size=5, max_concurrent=2)
   analyzer.display_results(results)
   analyzer.plot_analysis(results)
   analyzer.export_to_excel(results, "ozel_listem.xlsx")
5Ô∏è‚É£ TEK Hƒ∞SSE DETAYLI ANALƒ∞Z ƒ∞√áƒ∞N:
   # √ñnce analiz et
   results = await analyzer.batch_analyze(["THYAO"], batch_size=1, max_concurrent=1)
   # Sonu√ßlarƒ± g√∂ster
   if results:
       df = pd.DataFrame(results)
       display(df.T)  # Transpoz g√∂sterim
       # Detaylƒ± skorlarƒ± yazdƒ±r
       print("üìä SAƒûLIK SKORU DETAYLARI:")
       for key, value in results[0]['SAƒûLIK SKORU']['details'].items():
           print(f"  {key}: {value}")
       print("\\nüìä DEƒûERLEME SKORU DETAYLARI:")
       for key, value in results[0]['DEƒûERLEME SKORU']['details'].items():
           print(f"  {key}: {value}")
       print("\\nüìä GELECEK SKORU DETAYLARI:")
       for key, value in results[0]['GELECEK SKORU']['details'].items():
           print(f"  {key}: {value}")
       print("\\nüéØ HEDEF Fƒ∞YAT Bƒ∞LGƒ∞LERƒ∞:")
       print(f"  Mevcut Fiyat: {results[0]['Fƒ∞YAT']} TL")
       print(f"  Hedef Fiyat: {results[0]['HEDEF Fƒ∞YAT']} TL")
       print(f"  Y√ºkseli≈ü Potansiyeli: %{results[0]['Y√úKSELƒ∞≈û POTANSƒ∞YELƒ∞ (%)']}")
       print(f"  A√ßƒ±klama: {results[0]['HEDEF Fƒ∞YAT A√áIKLAMA']}")

- ƒ∞lk √ßalƒ±≈ütƒ±rmada k√º√ß√ºk listeyle ba≈ülayƒ±n
- √ñnbellekleme sayesinde tekrar eden analizler hƒ±zlƒ±dƒ±r
- Rate limiting nedeniyle b√ºy√ºk listeler zaman alabilir
- Backtest i√ßin ge√ßmi≈ü veriler kullanƒ±lƒ±r, bu nedenle sonu√ßlar ge√ßmi≈ü performansa dayanƒ±r
- Mobil uygulama i√ßin bu kod bir API backend olarak kullanƒ±labilir
üéØ YATIRIM SKORU ANLAMI:
- 80-100: √áOK ƒ∞Yƒ∞ (G√º√ßl√º alƒ±m sinyali)
- 60-79: ƒ∞Yƒ∞ (Alƒ±m d√º≈ü√ºn√ºlebilir)
- 40-59: ORTA (N√∂tr, izlenmeli)
- 20-39: ZAYIF (Satƒ±≈ü d√º≈ü√ºn√ºlebilir)
- 0-19: √áOK ZAYIF (Ka√ßƒ±nƒ±lmalƒ±)
üìà DEƒûERLEME ORANLARI DOƒûRU MANTIƒûI:
- F/K: D√º≈ü√ºk = Ucuz, Y√ºksek = Pahalƒ±
- PD/DD: D√º≈ü√ºk = Ucuz, Y√ºksek = Pahalƒ±
- EV/EBITDA: D√º≈ü√ºk = Ucuz, Y√ºksek = Pahalƒ± """)
