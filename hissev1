# ğŸ“Š TCMB EVDS API ile TÃ¼rkiye Ekonomik DÃ¶ngÃ¼ Analizi
# Google Colab iÃ§in hazÄ±rlanmÄ±ÅŸtÄ±r.
!pip install openpyxl matplotlib pandas seaborn plotly scipy pillow --quiet
import os
import io
import pandas as pd
import numpy as np
import matplotlib.pyplot as plt
import seaborn as sns
import plotly.graph_objects as go
import plotly.subplots as sp
import requests
import json
from plotly.subplots import make_subplots
from scipy.signal import savgol_filter
from datetime import datetime, timedelta
from openpyxl.drawing.image import Image as XLImage
from openpyxl import load_workbook
import warnings
warnings.filterwarnings('ignore')

# ==============================
# 1. API KEY AYARI VE KONFÄ°GÃœRASYON
# ==============================
api_key = "fylcsyNNCR"   # TCMB EVDS API key
headers = {"key": api_key}  # Sadece key gÃ¶nderiliyor

# TÃ¼rkÃ§e karakterleri matplotlib iÃ§in ayarla
plt.rcParams['font.family'] = ['DejaVu Sans']
plt.rcParams['figure.figsize'] = (15, 10)
plt.style.use('seaborn-v0_8')
# ==============================
# 2. EKONOMÄ°K DÃ–NGÃœ SERÄ°LERÄ°NÄ° TANIMLA (KILAVUZA GÃ–RE)
# ==============================
# KILAVUZDA OLAN SERÄ°LER KULLANILDI
series_config = {
    "TÃœFE AylÄ±k (%)": {
        "code": "TP.FG.J0",
        "frequency": "5",  # AylÄ±k
        "scale": 1
    },
    "TÃœFE YÄ±llÄ±k (%)": {
        "code": "TP.FG.J0-3",
        "frequency": "5",  # AylÄ±k
        "scale": 1
    },
    "Politika Faizi (%)": {
        "code": "TP.TRY.MT04",
        "frequency": "6",  # AylÄ±k
        "scale": 1
    },
    "Ä°ÅŸsizlik OranÄ± (%)": {
        "code": "TP.TIG08",
        "frequency": "1",  # 3 aylÄ±k
        "scale": 1
    },
    "Ä°stihdam OranÄ± (%)": {
        "code": "TP.TIG07",
        "frequency": "1",  # 3 aylÄ±k
        "scale": 1
    },
    "Sanayi Ãœretim Endeksi": {
        "code": "TP.TSANAYMT2021.Y14",
        "frequency": "6",  # AylÄ±k
        "scale": 0.01  # Milyon -> birim
    },
    "Kapasite KullanÄ±m (%)": {
        "code": "TP.KKO2.IS.TOP",
        "frequency": "5",  # AylÄ±k
        "scale": 1
    },
    "TÃ¼ketici GÃ¼ven Endeksi": {
        "code": "TP.TG2.Y01",
        "frequency": "5",  # AylÄ±k
        "scale": 1  # Milyon -> birim
    },
    "Reel Kesim GÃ¼ven Endeksi": {
        "code": "TP.GY1.N2",
        "frequency": "5",  # AylÄ±k
        "scale": 1
    },
    "USD/TL": {
        "code": "TP.DK.USD.S.YTL",
        "frequency": "1",  # AylÄ±k
        "scale": 1  # Bin -> birim
    },
    "BIST 100": {
        "code": "TP.MK.F.BILESIK",
        "frequency": "1",  # AylÄ±k
        "scale": 1
    },
    "Toplam Kredi Hacmi": {
        "code": "TP.KREDI.L001",
        "frequency": "5",  # AylÄ±k
        "scale": 0.000001  # Milyon TL -> TL
    },
    "Ä°hracat": {
        "code": "TP.IHRACATBEC.9999",
        "frequency": "5",  # AylÄ±k
        "scale": 0.000001  # Milyon $ -> $
    },
    "Ä°thalat": {
        "code": "TP.ITHALATBEC.9999",
        "frequency": "5",  # AylÄ±k
        "scale": 0.000001  # Milyon $ -> $
    },
}

# ==============================
# 3. VERÄ°LERÄ° Ã‡EK VE TEMÄ°ZLE (TAMAMEN YENÄ°LENDÄ°)
# ==============================
def try_get_series(code, start_date, end_date, frequency="1"):
    """EVDS API'den tek bir seri iÃ§in veri Ã§eker (tarih formatÄ± sorununu Ã§Ã¶zer)"""
    try:
        base_url = "https://evds2.tcmb.gov.tr/service/evds/"
        url = f"{base_url}series={code}&startDate={start_date}&endDate={end_date}&type=json&frequency={frequency}"
        
        response = requests.get(url, headers=headers, timeout=10)
        
        if response.status_code == 200:
            try:
                data = response.json()
                
                if isinstance(data, dict) and 'error' in data:
                    print(f"âŒ API HatasÄ±: {data['error']}")
                    return None
                
                if 'items' in data and len(data['items']) > 0:
                    df = pd.DataFrame(data['items'])
                    
                    # Tarih sÃ¼tununu esnek ÅŸekilde Ã§evir (Ã‡Ã–ZÃœM)
                    if 'Tarih' in df.columns:
                        # FarklÄ± formatlarÄ± dene
                        for fmt in ['%d-%m-%Y', '%Y-%m-%d', '%d-%m-%y', '%Y-%m', '%Y-%m-%d %H:%M:%S']:
                            try:
                                df['Tarih'] = pd.to_datetime(df['Tarih'], format=fmt)
                                break
                            except:
                                continue
                        else:
                            # HiÃ§biri uyÅŸmazsa pandas'a bÄ±rak
                            df['Tarih'] = pd.to_datetime(df['Tarih'], errors='coerce')
                        
                        df.set_index('Tarih', inplace=True)
                        
                        # SÃ¼tun adÄ±nÄ± dÃ¼zelt
                        if code.replace('.', '_') in df.columns:
                            return df[[code.replace('.', '_')]]
                        elif code in df.columns:
                            return df[[code]]
                    else:
                        print(f"âŒ 'Tarih' sÃ¼tunu bulunamadÄ±. Mevcut: {list(df.columns)}")
                else:
                    print(f"âŒ Veri bulunamadÄ±. YanÄ±t: {data}")
            except json.JSONDecodeError:
                print(f"âŒ JSON hatasÄ±: {response.text}")
        else:
            print(f"âŒ HTTP HatasÄ±: {response.status_code} - {response.text}")
    except Exception as e:
        print(f"âŒ Genel Hata: {e}")
    return None

def fetch_economic_data(series_config, start_date="01-01-2000", end_date="18-08-2025"):
    """Ekonomik verileri Ã§eker ve doÄŸru ÅŸekilde iÅŸler"""
    data = {}
    failed_series = []
    
    for name, config in series_config.items():
        print(f"\nğŸ“Š {name} verisi Ã§ekiliyor... (kod: {config['code']}, frekans: {config['frequency']})")
        
        df = try_get_series(config['code'], start_date, end_date, config['frequency'])
        
        if df is not None and not df.empty:
            df = df.rename(columns={df.columns[0]: name})
            
            # VERÄ° TEMÄ°ZLÄ°ME VE Ã–LÃ‡EKLENDÄ°RME
            for col in df.columns:
                # OndalÄ±k ayracÄ± dÃ¼zeltme (virgÃ¼l -> nokta)
                df[col] = df[col].astype(str).str.replace(',', '.', regex=True)
                
                # SayÄ±ya Ã§evir
                df[col] = pd.to_numeric(df[col], errors='coerce')
                
                # Ã–lÃ§eklendirme
                df[col] = df[col] * config['scale']
                
                # NaN deÄŸerleri doldur
                df[col] = df[col].fillna(method='ffill').fillna(method='bfill')
            
            # Frekansa gÃ¶re yeniden Ã¶rnekleme
            if config['frequency'] == "3":  # 3 aylÄ±k -> aylÄ±k
                df = df.resample('M').interpolate()
            elif config['frequency'] == "1":  # AylÄ±k
                df = df.resample('M').last()
            # DiÄŸer frekanslar iÃ§in gerekirse buraya eklenebilir
            
            data[name] = df
            ok_pts = df[name].dropna().shape[0]
            
            # Ã–rnek deÄŸer gÃ¶ster
            sample_val = df[name].iloc[-1] if len(df) > 0 else None
            print(f"âœ… {name} baÅŸarÄ±yla Ã§ekildi ve iÅŸlendi ({ok_pts} aylÄ±k gÃ¶zlem)")
            if sample_val is not None:
                print(f"ğŸ“ Ã–rnek deÄŸer: {sample_val:.2f}")
        else:
            print(f"âŒ {name} iÃ§in veri alÄ±namadÄ±.")
            failed_series.append(name)
    
    # BaÅŸarÄ±lÄ± verileri birleÅŸtir
    if data:
        # TÃ¼m indekslerin birleÅŸimi
        all_index = None
        for df in data.values():
            all_index = df.index if all_index is None else all_index.union(df.index)
        
        aligned = {}
        for name, df in data.items():
            aligned[name] = df.reindex(all_index)
        
        df_all = pd.concat(aligned.values(), axis=1)
        df_all = df_all.sort_index()
        
        # Sadece sayÄ±sal sÃ¼tunlarÄ± seÃ§
        numeric_cols = df_all.select_dtypes(include=[np.number]).columns
        df_all = df_all[numeric_cols]
        
        # AykÄ±rÄ± boÅŸluklarÄ± doldur
        df_all = df_all.interpolate(method='linear').fillna(method='bfill').fillna(method='ffill')
        
        print(f"\nâœ… Toplam {len(df_all.columns)} seri baÅŸarÄ±yla yÃ¼klendi ve iÅŸlendi")
        print(f"ğŸ“… Veri aralÄ±ÄŸÄ±: {df_all.index.min().strftime('%Y-%m')} - {df_all.index.max().strftime('%Y-%m')}")
        print(f"ğŸ“Š SayÄ±sal sÃ¼tunlar: {list(df_all.columns)}")
        
        # Ã–rnek deÄŸerleri gÃ¶ster
        print("\nğŸ“Š Ã–LÃ‡EKLENMÄ°Å Ã–RNEK DEÄERLER:")
        for col in df_all.columns[:5]:  # Ä°lk 5 sÃ¼tun
            sample_val = df_all[col].iloc[-1] if len(df_all) > 0 else None
            if sample_val is not None:
                print(f"   â€¢ {col}: {sample_val:.2f}")
    else:
        df_all = pd.DataFrame()
    
    return df_all, failed_series

# ==============================
# 4. EKONOMÄ°K DÃ–NGÃœ ANALÄ°ZÄ° FONKSÄ°YONLARI (DEÄÄ°ÅÄ°KLÄ°K YOK)
# ==============================
def detect_economic_cycles(df):
    """Ekonomik dÃ¶ngÃ¼ fazlarÄ±nÄ± tespit eder"""
    growth_indicators = []
    
    # GSYH BÃ¼yÃ¼me (yoksa atla)
    if "GSYH BÃ¼yÃ¼me (%)" in df.columns:
        growth_indicators.append(df["GSYH BÃ¼yÃ¼me (%)"].fillna(0) * 0.3)
    
    # Sanayi Ã¼retimi (yÄ±llÄ±k % deÄŸiÅŸim)
    if "Sanayi Ãœretim Endeksi" in df.columns:
        sue_growth = df["Sanayi Ãœretim Endeksi"].pct_change(12) * 100
        growth_indicators.append(sue_growth.fillna(0) * 0.25)
    
    # Ä°ÅŸsizlik (ters iÅŸaret)
    if "Ä°ÅŸsizlik OranÄ± (%)" in df.columns:
        unemployment_inv = -(df["Ä°ÅŸsizlik OranÄ± (%)"] - df["Ä°ÅŸsizlik OranÄ± (%)"].mean())
        growth_indicators.append(unemployment_inv.fillna(0) * 0.2)
    
    # TÃ¼ketici gÃ¼veni (merkezlenmiÅŸ)
    if "TÃ¼ketici GÃ¼ven Endeksi" in df.columns:
        consumer_conf = df["TÃ¼ketici GÃ¼ven Endeksi"] - df["TÃ¼ketici GÃ¼ven Endeksi"].mean()
        growth_indicators.append(consumer_conf.fillna(0) * 0.15)
    
    # Kapasite kullanÄ±m (merkezlenmiÅŸ)
    if "Kapasite KullanÄ±m (%)" in df.columns:
        capacity = df["Kapasite KullanÄ±m (%)"] - df["Kapasite KullanÄ±m (%)"].mean()
        growth_indicators.append(capacity.fillna(0) * 0.1)
    
    if growth_indicators:
        composite_indicator = sum(growth_indicators)
        
        # DÃ¼zleÅŸtir
        window_len = min(13, max(3, (len(composite_indicator) // 3) | 1))  # tek sayÄ±
        if len(composite_indicator.dropna()) >= window_len:
            composite_smooth = savgol_filter(composite_indicator.fillna(0), window_length=window_len, polyorder=2)
        else:
            composite_smooth = composite_indicator.fillna(0).values
        
        # Fazlar
        phases = []
        for v in composite_smooth:
            if v > 1.5:
                phases.append("GeniÅŸleme")
            elif v > 0.5:
                phases.append("Tepe")
            elif v > -1.5:
                phases.append("Ä°yileÅŸme")
            else:
                phases.append("Daralma")
        
        cycle_df = pd.DataFrame({
            'Tarih': df.index,
            'BileÅŸik_GÃ¶sterge': composite_smooth,
            'DÃ¶ngÃ¼_FazÄ±': phases
        }).set_index('Tarih')
        
        return cycle_df
    return pd.DataFrame()

def analyze_cycle_characteristics(df, cycle_df):
    """DÃ¶ngÃ¼ fazlarÄ±nÄ±n Ã¶zelliklerini analiz eder"""
    if cycle_df.empty or df.empty:
        return {}
    
    analysis_df = df.join(cycle_df, how='inner')
    phase_stats = {}
    
    for phase in ['GeniÅŸleme', 'Tepe', 'Daralma', 'Ä°yileÅŸme']:
        phase_data = analysis_df[analysis_df['DÃ¶ngÃ¼_FazÄ±'] == phase]
        if len(phase_data) > 0:
            stats = {}
            for col in df.columns:
                if col in phase_data.columns and pd.api.types.is_numeric_dtype(phase_data[col]):
                    stats[col] = {
                        'ortalama': phase_data[col].mean(),
                        'std': phase_data[col].std(),
                        'min': phase_data[col].min(),
                        'max': phase_data[col].max()
                    }
            
            phase_stats[phase] = {
                'istatistikler': stats,
                'dÃ¶nem_sayÄ±sÄ±': len(phase_data),
                'toplam_sÃ¼re_ay': len(phase_data)
            }
    
    return phase_stats

# ==============================
# 5. GRAFÄ°K FONKSÄ°YONLARI (DEÄÄ°ÅÄ°KLÄ°K YOK)
# ==============================
def create_economic_dashboard(df, cycle_df):
    """Ekonomik dÃ¶ngÃ¼ dashboard'u oluÅŸturur (Plotly)"""
    fig = make_subplots(
        rows=4, cols=2,
        subplot_titles=[
            'BileÅŸik Ekonomik GÃ¶sterge & DÃ¶ngÃ¼ FazlarÄ±',
            'GSYH BÃ¼yÃ¼me & Sanayi Ãœretimi',
            'Ä°ÅŸsizlik & Ä°stihdam OranlarÄ±',
            'TÃ¼ketici & Reel Kesim GÃ¼ven Endeksleri',
            'Enflasyon & Politika Faizi',
            'BIST 100 & Kredi Hacmi',
            'Kapasite KullanÄ±m & PMI',
            'Cari Denge & DÄ±ÅŸ Ticaret'
        ],
        vertical_spacing=0.06,
        horizontal_spacing=0.1
    )
    
    color_map = {'GeniÅŸleme': 'green','Tepe': 'orange','Daralma': 'red','Ä°yileÅŸme': 'blue'}
    
    if not cycle_df.empty:
        fig.add_trace(
            go.Scatter(x=cycle_df.index, y=cycle_df['BileÅŸik_GÃ¶sterge'],
                       mode='lines', name='BileÅŸik GÃ¶sterge',
                       line=dict(width=3, color='black')),
            row=1, col=1
        )
        
        current_phase = None
        start_date = None
        for date, phase in zip(cycle_df.index, cycle_df['DÃ¶ngÃ¼_FazÄ±']):
            if phase != current_phase:
                if current_phase is not None:
                    fig.add_vrect(x0=start_date, x1=date,
                                  fillcolor=color_map.get(current_phase, 'gray'),
                                  opacity=0.2, layer="below", line_width=0,
                                  row=1, col=1)
                current_phase = phase
                start_date = date
        
        if current_phase is not None:
            fig.add_vrect(x0=start_date, x1=cycle_df.index[-1],
                          fillcolor=color_map.get(current_phase, 'gray'),
                          opacity=0.2, layer="below", line_width=0,
                          row=1, col=1)
    
    graph_configs = [
        (['GSYH BÃ¼yÃ¼me (%)', 'Sanayi Ãœretim Endeksi'], 1, 2),
        (['Ä°ÅŸsizlik OranÄ± (%)', 'Ä°stihdam OranÄ± (%)'], 2, 1),
        (['TÃ¼ketici GÃ¼ven Endeksi', 'Reel Kesim GÃ¼ven Endeksi'], 2, 2),
        (['TÃœFE YÄ±llÄ±k (%)', 'Politika Faizi (%)'], 3, 1),
        (['BIST 100', 'Toplam Kredi Hacmi'], 3, 2),
        (['Kapasite KullanÄ±m (%)', 'Ä°malat Sanayi PMI'], 4, 1),
        (['Cari Denge/GSYH (%)', 'Ä°hracat'], 4, 2)
    ]
    
    for cols, row, col in graph_configs:
        for series_name in cols:
            if series_name in df.columns:
                fig.add_trace(
                    go.Scatter(x=df.index, y=df[series_name],
                               mode='lines', name=series_name, showlegend=False),
                    row=row, col=col
                )
    
    fig.update_layout(height=1600, title_text="ğŸ‡¹ğŸ‡· TÃ¼rkiye Ekonomik DÃ¶ngÃ¼ Analizi Dashboard", title_x=0.5, showlegend=True)
    return fig

def create_cycle_phase_analysis(phase_stats):
    """DÃ¶ngÃ¼ fazlarÄ± analiz grafiÄŸi (Polar)"""
    if not phase_stats:
        return None
    
    phases = list(phase_stats.keys())
    key_indicators = ['GSYH BÃ¼yÃ¼me (%)', 'Ä°ÅŸsizlik OranÄ± (%)', 'TÃ¼ketici GÃ¼ven Endeksi', 'TÃœFE YÄ±llÄ±k (%)', 'BIST 100']
    
    fig = go.Figure()
    for phase in phases:
        if 'istatistikler' in phase_stats[phase]:
            values, indicators = [], []
            for indicator in key_indicators:
                if indicator in phase_stats[phase]['istatistikler']:
                    val = phase_stats[phase]['istatistikler'][indicator]['ortalama']
                    values.append(val)
                    indicators.append(indicator)
            
            if values:
                fig.add_trace(go.Scatterpolar(r=values, theta=indicators, fill='toself', name=phase, opacity=0.6))
    
    fig.update_layout(polar=dict(radialaxis=dict(visible=True)), title="Ekonomik DÃ¶ngÃ¼ FazlarÄ± - GÃ¶sterge Analizi", showlegend=True)
    return fig

# ==============================
# 6. RAPOR OLUÅTURMA (DEÄÄ°ÅÄ°KLÄ°K YOK)
# ==============================
def generate_economic_report(df, cycle_df, phase_stats):
    """Ekonomik analiz raporu (metin olarak dÃ¶ner; Excel'de Rapor_Metin sayfasÄ±na yazÄ±lacak)"""
    current_date = datetime.now().strftime("%Y-%m-%d")
    latest_data = df.tail(1)
    
    if not cycle_df.empty:
        current_phase = cycle_df['DÃ¶ngÃ¼_FazÄ±'].iloc[-1]
        current_indicator = cycle_df['BileÅŸik_GÃ¶sterge'].iloc[-1]
    else:
        current_phase = "Belirsiz"
        current_indicator = 0
    
    report = f"""
ğŸ“Š TÃœRKÄ°YE EKONOMÄ°K DÃ–NGÃœ ANALÄ°Z RAPORU
{'='*50}
ğŸ“… Rapor Tarihi: {current_date}
ğŸ“ˆ GÃ¼ncel Ekonomik Faz: {current_phase}
ğŸ¯ BileÅŸik GÃ¶sterge DeÄŸeri: {current_indicator:.2f}
ğŸ“‹ GÃœNCEL EKONOMÄ°K GÃ–STERGELER
{'-'*30}
"""
    
    for col in df.columns[:10]:
        if col in latest_data.columns:
            latest_val = latest_data[col].iloc[0]
            if pd.notna(latest_val):
                report += f"â€¢ {col}: {latest_val:.2f}\n"
    
    if phase_stats:
        report += f"\nğŸ”„ EKONOMÄ°K DÃ–NGÃœ FAZ ANALÄ°ZÄ°\n{'-'*30}\n"
        for phase, stats in phase_stats.items():
            report += f"\nğŸ“Œ {phase.upper()} DÃ–NEMÄ°:\n"
            report += f"  â€¢ Toplam SÃ¼re: {stats.get('toplam_sÃ¼re_ay', 0)} ay\n"
            report += f"  â€¢ GÃ¶zlem SayÄ±sÄ±: {stats.get('dÃ¶nem_sayÄ±sÄ±', 0)}\n"
            for indicator in ['GSYH BÃ¼yÃ¼me (%)', 'Ä°ÅŸsizlik OranÄ± (%)', 'TÃœFE YÄ±llÄ±k (%)']:
                if indicator in stats.get('istatistikler', {}):
                    avg_val = stats['istatistikler'][indicator]['ortalama']
                    report += f"  â€¢ {indicator}: {avg_val:.2f}\n"
    
    report += f"""
ğŸ’¡ EKONOMÄ°K DÃ–NGÃœ Ã–NERÄ°LERÄ°
{'-'*30}
"""
    
    if current_phase == "GeniÅŸleme":
        report += "âœ… YatÄ±rÄ±m fÄ±rsatlarÄ±, istihdam artÄ±ÅŸÄ±, enflasyon baskÄ±sÄ± izlenmeli.\n"
    elif current_phase == "Tepe":
        report += "âš ï¸ AÅŸÄ±rÄ± Ä±sÄ±nma riski, temkinli duruÅŸ, faiz artÄ±ÅŸÄ± olasÄ±.\n"
    elif current_phase == "Daralma":
        report += "ğŸ“‰ Nakit yÃ¶netimi, maliyet kontrolÃ¼, yatÄ±rÄ±mlar ertelenebilir.\n"
    elif current_phase == "Ä°yileÅŸme":
        report += "ğŸ”„ Erken yatÄ±rÄ±m fÄ±rsatlarÄ±, kademeli iyileÅŸme, iyimserlik artÄ±yor.\n"
    
    return report.strip()

# ==============================
# 7. MATPLOTLIB Ã–ZET GRAFÄ°K (DEÄÄ°ÅÄ°KLÄ°K YOK)
# ==============================
def create_summary_matplotlib_chart(df, cycle_df, save_path=None):
    """Matplotlib ile Ã¶zet grafik oluÅŸturur (PNG kaydÄ± opsiyonel)"""
    fig, axes = plt.subplots(2, 2, figsize=(20, 15))
    fig.suptitle('ğŸ‡¹ğŸ‡· TÃ¼rkiye Ekonomik DÃ¶ngÃ¼ Ã–zeti', fontsize=20, fontweight='bold')
    
    # 1. BileÅŸik gÃ¶sterge
    if not cycle_df.empty:
        ax = axes[0, 0]
        ax.plot(cycle_df.index, cycle_df['BileÅŸik_GÃ¶sterge'], linewidth=3, color='black', label='BileÅŸik GÃ¶sterge')
        ax.axhline(y=0, color='gray', linestyle='--', alpha=0.7)
        ax.set_title('BileÅŸik Ekonomik GÃ¶sterge', fontsize=14, fontweight='bold')
        ax.set_ylabel('GÃ¶sterge DeÄŸeri')
        ax.grid(True, alpha=0.3)
        ax.legend()
        
        phase_colors = {'GeniÅŸleme': 'green', 'Tepe': 'orange', 'Daralma': 'red', 'Ä°yileÅŸme': 'blue'}
        current_phase = cycle_df['DÃ¶ngÃ¼_FazÄ±'].iloc[0]
        start_idx = 0
        for i, phase in enumerate(cycle_df['DÃ¶ngÃ¼_FazÄ±']):
            if phase != current_phase or i == len(cycle_df) - 1:
                end_idx = i if i != len(cycle_df) - 1 else i + 1
                ax.axvspan(cycle_df.index[start_idx], cycle_df.index[min(end_idx, len(cycle_df)-1)],
                           alpha=0.2, color=phase_colors.get(current_phase, 'gray'))
                current_phase = phase
                start_idx = i
    
    # 2. GSYH & Ä°ÅŸsizlik
    ax = axes[0, 1]
    if 'GSYH BÃ¼yÃ¼me (%)' in df.columns:
        ax.plot(df.index, df['GSYH BÃ¼yÃ¼me (%)'], label='GSYH BÃ¼yÃ¼me (%)', color='blue', linewidth=2)
    
    if 'Ä°ÅŸsizlik OranÄ± (%)' in df.columns:
        ax2 = ax.twinx()
        ax2.plot(df.index, df['Ä°ÅŸsizlik OranÄ± (%)'], label='Ä°ÅŸsizlik (%)', color='red', linewidth=2)
        ax2.set_ylabel('Ä°ÅŸsizlik OranÄ± (%)', color='red')
        ax2.tick_params(axis='y', labelcolor='red')
    
    ax.set_title('GSYH BÃ¼yÃ¼me & Ä°ÅŸsizlik OranÄ±', fontsize=14, fontweight='bold')
    ax.set_ylabel('GSYH BÃ¼yÃ¼me (%)', color='blue')
    ax.tick_params(axis='y', labelcolor='blue')
    ax.grid(True, alpha=0.3)
    
    if 'GSYH BÃ¼yÃ¼me (%)' in df.columns or 'Ä°ÅŸsizlik OranÄ± (%)' in df.columns:
        ax.legend(loc='upper left')
        if 'Ä°ÅŸsizlik OranÄ± (%)' in df.columns:
            ax2.legend(loc='upper right')
    
    # 3. Enflasyon & Faiz
    ax = axes[1, 0]
    if 'TÃœFE YÄ±llÄ±k (%)' in df.columns:
        ax.plot(df.index, df['TÃœFE YÄ±llÄ±k (%)'], label='TÃœFE YÄ±llÄ±k (%)', color='orange', linewidth=2)
    elif 'TÃœFE AylÄ±k (%)' in df.columns:
        ax.plot(df.index, df['TÃœFE AylÄ±k (%)'], label='TÃœFE AylÄ±k (%)', color='orange', linewidth=2)
    
    if 'Politika Faizi (%)' in df.columns:
        ax.plot(df.index, df['Politika Faizi (%)'], label='Politika Faizi (%)', color='purple', linewidth=2)
    
    ax.set_title('Enflasyon & Politika Faizi', fontsize=14, fontweight='bold')
    ax.set_ylabel('Oran (%)')
    ax.legend()
    ax.grid(True, alpha=0.3)
    
    # 4. GÃ¼ven endeksleri
    ax = axes[1, 1]
    if 'TÃ¼ketici GÃ¼ven Endeksi' in df.columns:
        ax.plot(df.index, df['TÃ¼ketici GÃ¼ven Endeksi'], label='TÃ¼ketici GÃ¼veni', color='green', linewidth=2)
    
    if 'Reel Kesim GÃ¼ven Endeksi' in df.columns:
        ax.plot(df.index, df['Reel Kesim GÃ¼ven Endeksi'], label='Reel Kesim GÃ¼veni', color='brown', linewidth=2)
    
    ax.set_title('GÃ¼ven Endeksleri', fontsize=14, fontweight='bold')
    ax.set_ylabel('Endeks')
    ax.legend()
    ax.grid(True, alpha=0.3)
    
    plt.tight_layout()
    
    if save_path:
        plt.savefig(save_path, dpi=150, bbox_inches='tight')
    
    plt.show()

def save_composite_plot_png(cycle_df, path):
    """BileÅŸik gÃ¶stergeyi tek baÅŸÄ±na PNG olarak kaydeder."""
    if cycle_df.empty:
        return
    
    plt.figure(figsize=(16,6))
    plt.plot(cycle_df.index, cycle_df['BileÅŸik_GÃ¶sterge'], linewidth=3)
    plt.axhline(y=0, linestyle='--')
    plt.title('BileÅŸik Ekonomik GÃ¶sterge')
    plt.ylabel('DeÄŸer')
    plt.grid(True, alpha=0.3)
    plt.tight_layout()
    plt.savefig(path, dpi=150, bbox_inches='tight')
    plt.close()

# ==============================
# 8. ANA UYGULAMA (DEÄÄ°ÅÄ°KLÄ°K YOK)
# ==============================
def main():
    """Ana uygulama fonksiyonu"""
    print("ğŸš€ TÃ¼rkiye Ekonomik DÃ¶ngÃ¼ Analizi BaÅŸlatÄ±lÄ±yor...\n")
    
    # 1. Verileri Ã§ek
    print("ğŸ“Š TCMB EVDS verilerinden ekonomik gÃ¶stergeler Ã§ekiliyor...")
    df_economic, failed = fetch_economic_data(series_config)
    
    if df_economic.empty:
        print("âŒ Veri Ã§ekme baÅŸarÄ±sÄ±z. LÃ¼tfen API anahtarÄ±nÄ± ve seri kodlarÄ±nÄ± kontrol edin.")
        return None, None, None
    
    if failed:
        print("\nâš ï¸ AÅŸaÄŸÄ±daki gÃ¶stergeler iÃ§in veri alÄ±namadÄ±:")
        for f in failed:
            print("   -", f)
    
    # 2. DÃ¶ngÃ¼ analizi
    print("\nğŸ”„ Ekonomik dÃ¶ngÃ¼ analizi yapÄ±lÄ±yor...")
    cycle_df = detect_economic_cycles(df_economic)
    
    # 3. Faz analizi
    print("ğŸ“ˆ DÃ¶ngÃ¼ fazlarÄ± analiz ediliyor...")
    phase_stats = analyze_cycle_characteristics(df_economic, cycle_df)
    
    # 4. Rapor metni
    print("\nğŸ“ Rapor metni hazÄ±rlanÄ±yor...")
    report_text = generate_economic_report(df_economic, cycle_df, phase_stats)
    
    # 5. Excel raporu kaydet (grafikleri ve rapor metnini de ekle)
    print("\nğŸ’¾ Excel raporu hazÄ±rlanÄ±yor...")
    excel_file = f"turkiye_ekonomik_dongu_analizi_{datetime.now().strftime('%Y%m%d')}.xlsx"
    
    # Grafik dosyalarÄ±nÄ± geÃ§ici olarak kaydet
    summary_png = "ozet_grafik.png"
    composite_png = "bilesik_gosterge.png"
    
    try:
        create_summary_matplotlib_chart(df_economic, cycle_df, save_path=summary_png)
        save_composite_plot_png(cycle_df, composite_png)
    except Exception as e:
        print("âš ï¸ Grafik kaydetmede hata:", e)
    
    try:
        with pd.ExcelWriter(excel_file, engine='openpyxl') as writer:
            # Ana veriler
            df_economic.to_excel(writer, sheet_name='Ekonomik_Veriler')
            
            # DÃ¶ngÃ¼ analizi
            if not cycle_df.empty:
                cycle_df.to_excel(writer, sheet_name='Dongu_Analizi')
            
            # Faz istatistikleri
            phase_summary_data = {}
            if phase_stats:
                for phase, stats in phase_stats.items():
                    phase_summary_data[phase] = {
                        'DÃ¶nem SayÄ±sÄ± (Ay)': stats.get('dÃ¶nem_sayÄ±sÄ±', np.nan),
                        'Toplam SÃ¼re (Ay)': stats.get('toplam_sÃ¼re_ay', np.nan)
                    }
                    
                    if 'istatistikler' in stats:
                        for indicator, values in stats['istatistikler'].items():
                            if isinstance(values, dict) and 'ortalama' in values:
                                phase_summary_data[phase][f'{indicator} (Ort.)'] = values['ortalama']
                                phase_summary_data[phase][f'{indicator} (Std.)'] = values['std']
                                phase_summary_data[phase][f'{indicator} (Min)'] = values['min']
                                phase_summary_data[phase][f'{indicator} (Max)'] = values['max']
                
                if phase_summary_data:
                    phase_summary_df = pd.DataFrame.from_dict(phase_summary_data, orient='index')
                    phase_summary_df.to_excel(writer, sheet_name='Faz_Istatistikleri_Ozet')
            
            # Rapor metni sayfasÄ±
            # Ã‡ok satÄ±rlÄ± hÃ¼creye yazÄ±yoruz
            pd.DataFrame({"RAPOR": [report_text]}).to_excel(writer, sheet_name='Rapor_Metin', index=False)
            
            # Åimdilik writer'Ä± flush et
            writer.book.create_sheet('Grafik_Ozet')
            writer.book.create_sheet('Grafik_Bilesik')
        
        # openpyxl ile resimleri gÃ¶m
        wb = load_workbook(excel_file)
        
        # Ã–zet grafik
        if os.path.exists(summary_png):
            ws_ozet = wb['Grafik_Ozet']
            img1 = XLImage(summary_png)
            img1.anchor = 'A1'
            ws_ozet.add_image(img1)
        
        # BileÅŸik grafik
        if os.path.exists(composite_png):
            ws_bil = wb['Grafik_Bilesik']
            img2 = XLImage(composite_png)
            img2.anchor = 'A1'
            ws_bil.add_image(img2)
        
        wb.save(excel_file)
        print(f"âœ… Excel dosyasÄ± kaydedildi: {excel_file}")
        
        # 6. Colab'den indir (sadece EXCEL)
        try:
            from google.colab import files
            files.download(excel_file)
            print("ğŸ“¥ Excel dosyasÄ± indirme baÅŸlatÄ±ldÄ±.")
        except Exception as e:
            print("ğŸ’¡ Google Colab dÄ±ÅŸÄ±nda Ã§alÄ±ÅŸÄ±yorsunuz veya indirme engellendi. Dosya Ã§alÄ±ÅŸma dizininde.")
    except Exception as e:
        print(f"âŒ Excel raporu kaydedilirken hata oluÅŸtu: {e}")
    
    # 7. Ä°nteraktif dashboard gÃ¶ster
    print("\nğŸ“Š Ekonomik dashboard oluÅŸturuluyor...")
    dashboard_fig = create_economic_dashboard(df_economic, cycle_df)
    if dashboard_fig:
        dashboard_fig.show()
    
    # 8. Faz analizi grafiÄŸi
    if phase_stats:
        print("ğŸ¯ DÃ¶ngÃ¼ faz analizi grafiÄŸi oluÅŸturuluyor...")
        phase_fig = create_cycle_phase_analysis(phase_stats)
        if phase_fig:
            phase_fig.show()
    
    return df_economic, cycle_df, phase_stats

# ==============================
# 9. EK ANALÄ°Z FONKSÄ°YONLARI (DEÄÄ°ÅÄ°KLÄ°K YOK)
# ==============================
def correlation_analysis(df):
    """GÃ¶stergeler arasÄ± korelasyon analizi"""
    numeric_cols = df.select_dtypes(include=[np.number]).columns
    if len(numeric_cols) > 1:
        corr_matrix = df[numeric_cols].corr()
        plt.figure(figsize=(15, 12))
        mask = np.triu(np.ones_like(corr_matrix, dtype=bool))
        sns.heatmap(corr_matrix, mask=mask, annot=True, cmap='RdYlBu_r', center=0,
                    square=True, linewidths=0.5, cbar_kws={"shrink": .8}, fmt='.2f')
        plt.title('Ekonomik GÃ¶stergeler Korelasyon Analizi', fontsize=16, fontweight='bold')
        plt.tight_layout()
        plt.show()
        return corr_matrix
    else:
        print("âš ï¸ Korelasyon analizi iÃ§in yeterli sayÄ±sal sÃ¼tun yok.")
        return None

def economic_forecasting(df, months_ahead=6):
    """Basit trend bazlÄ± tahmin"""
    forecasts = {}
    key_indicators = ['GSYH BÃ¼yÃ¼me (%)', 'Ä°ÅŸsizlik OranÄ± (%)', 'TÃœFE YÄ±llÄ±k (%)', 'TÃ¼ketici GÃ¼ven Endeksi', 'BIST 100']
    
    print(f"\nğŸ”® {months_ahead} AY Ã–NCESÄ° EKONOMÄ°K GÃ–STERGE TAHMÄ°NLERÄ°")
    print("=" * 60)
    
    for indicator in key_indicators:
        if indicator in df.columns:
            recent = df[indicator].dropna().tail(12)
            if len(recent) >= 3:
                x = np.arange(len(recent))
                slope = np.polyfit(x, recent.values, 1)[0]
                current_value = recent.iloc[-1]
                forecast_value = current_value + slope * months_ahead
                trend = "ğŸ“ˆ YÃœKSELME" if slope > 0.1 else ("ğŸ“‰ DÃœÅME" if slope < -0.1 else "â¡ï¸ STABÄ°L")
                
                forecasts[indicator] = {
                    'mevcut_deÄŸer': current_value, 
                    'tahmin_deÄŸer': forecast_value, 
                    'trend_eÄŸim': slope, 
                    'trend_yÃ¶n': trend
                }
                
                print(f"\nğŸ“Š {indicator}\n   Mevcut: {current_value:.2f} | {months_ahead} Ay Sonra: {forecast_value:.2f} | Trend: {trend} ({slope:.3f})")
    
    if not forecasts:
        print("\nâš ï¸ Tahmin yapÄ±labilecek yeterli gÃ¶sterge bulunamadÄ±.")
    
    return forecasts

# ==============================
# 10. Ã‡ALIÅTIR
# ==============================
if __name__ == "__main__":
    print("=" * 80)
    print("ğŸ‡¹ğŸ‡· TÃœRKÄ°YE EKONOMÄ°K DÃ–NGÃœ ANALÄ°Z SÄ°STEMÄ°")
    print("=" * 80)
    print("ğŸ“Š TCMB EVDS API ile kapsamlÄ± ekonomik analiz")
    print("ğŸ”„ Otomatik dÃ¶ngÃ¼ tespiti ve fazlama")
    print("ğŸ“ˆ Ä°nteraktif dashboard ve Excel iÃ§inde grafik/rapor")
    print("=" * 80)
    
    # Ana analizi Ã§alÄ±ÅŸtÄ±r
    df_main, cycle_main, phase_stats_main = main()
    
    if df_main is not None and not df_main.empty:
        print("""
ğŸ‰ TÃœRKÄ°YE EKONOMÄ°K DÃ–NGÃœ ANALÄ°ZÄ° TAMAMLANDI!
ğŸ“ Ã‡Ä±ktÄ±lar:
âœ… Excel raporu (.xlsx) â€” veri, metin rapor, gÃ¶mÃ¼lÃ¼ grafikler (ayrÄ± sayfalarda)
ğŸ“Š Ä°nteraktif Plotly dashboard
ğŸ“ˆ Matplotlib Ã¶zet grafikleri (Excel'e de eklendi)
        """)
    else:
        print("\nâŒ Analiz tamamlanamadÄ±. LÃ¼tfen yukarÄ±daki uyarÄ±larÄ± kontrol edin.")
